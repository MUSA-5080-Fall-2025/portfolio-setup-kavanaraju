{"title":"Sequence Analysis of Neighborhood Racial and Ethnic Changes: The Case of New York City 1980-2020","markdown":{"yaml":{"title":"Sequence Analysis of Neighborhood Racial and Ethnic Changes: The Case of New York City 1980-2020","author":[{"name":"Elizabeth Delmelle","affiliations":[{"name":"University of Pennsylvania","department":"City and Regional Planning"}],"orcid":"0000-0003-3735-8359","email":"delmelle@upenn.edu"},{"name":"Eric Delmelle","affiliations":[{"name":"Vrije University Brussels","department":"Geography"}],"orcid":"0000-0002-5117-2238","email":"delmelle@gmail.com"}],"date":"2024-09-16","abstract":"This paper demonstrates the application of sequence analysis to develop a typology of racial and ethnic trajectories in New York City neighborhoods from 1980 to 2020 using a reproducible R workflow. Our workflow begins with using an unsupervised classification method, k-means, at each decennial cross-section to derive 6 classes describing the racial and ethnic makeup of neighborhoods during the study period. These classes include four that depict a majority of Black, White, Hispanic, and Asian residents, and two mixed-race classes, Black and Hispanic, and a White majority with a mixture of other races. We then develop a sequence of classes for each census tract over the 5 decennial time stamps. Finally, we derive a longitudinal typology describing the predominant pathways of change using sequence analysis. This resulted in 14 distinct pathways including transitions to Hispanic and Asian majorities emerging from historically White or Black neighborhoods. The findings underscore the gradual nature of neighborhood racial transformations. Our approach is reproducible for researchers wanting to explore and visualize multidimensional neighborhood dynamics.\n","keywords":["sequence analysis","neighborhood change","New York City"],"toc":true,"format":{"pdf":{"toc":true,"highlight-style":"tango","documentclass":"article","include-in-header":"preamble.tex"}},"bibliography":"references.bib","editor_options":{"markdown":{"wrap":72}}},"headingText":"Introduction","headingAttr":{"id":"sec-intro","classes":[],"keyvalue":[]},"containsRefs":false,"markdown":"\n\n\nTracking and understanding neighborhood changes has been a central topic\nof urban studies and a fundamental concern for planning practitioners\n[@Galster2001; @Landis2016; @ChappleZuk2016]. Neighborhood change can be\ncomprehended according to various dimensions, from housing stock or\nbuilt environment changes to residents' demographic and socioeconomic\ncomposition [@Delmelle2022]. Thus, the study of neighborhood change\ninvolves analyzing multiple attribute dimensions through time for\nspatially situated units. Recent scholarship has progressed in the\nanalytical strategies used to study neighborhood trajectories,\nintroducing new methods for visualizing and mapping longitudinal\npathways of change for multiple dimensions [@Delmelle2022].\n\nIn this article, we demonstrate one such technique, sequence analysis,\nto explore decennial neighborhood racial and ethnic changes in New York\nCity from 1980-2020. The United States' demographic profile has become\nincreasingly diverse in the past several decades, driven by immigration\nand growing natural birth rates of the non-White population\n[@frey2022new]. Analyses following the release of the 2010 decennial\ncensus showed that increasing national diversity resulted in differing\nneighborhood trajectories, largely contingent on the broader\nmetropolitan context [@Terbeck2023; @Wright2014].\n\nMuch of the empirical scholarship on neighborhood racial and ethnic\nchanges has developed indices to categorize the makeup or diversity of\nracial and ethnic groups and then explored changes in a neighborhood's\ndiversity categorization over time. For example, a neighborhood might\ntransition from 'low diverse' to 'moderately diverse' from one decade to\nthe next [@farrell2011racial; @Wright2014]. Alternately, another set of\ntechniques aims to describe the longitudinal sequences or trajectories\nthat the racial and ethnic groups in a neighborhood have followed. Two\nmethods have been used for this purpose: statistical curve fitting and\nsequence analysis. With curve-fitting models like growth mixture models\nor latent growth models, mathematical functions fit each racial and\nethnic group under study that summarize the predominant trends\n[@Zwiers2018; @HippKim2023]. With sequence analysis, neighborhoods are\nfirst grouped into similar clusters according to their racial and ethnic\nmakeup using an unsupervised clustering algorithm like k-means. This is\ndone for all neighborhoods and all time stamps. Then, each neighborhood\nis assigned a categorical cluster over time, and finally, the sequences\nof these clusters are grouped using a sequence alignment technique\n[@Delmelle2016; @GonzalezLeonardo2023]. Both methods aim to develop a\ntypology of the predominant longitudinal pathways of change for multiple\nvariables at once.\n\nIn this article, we explore trajectories of neighborhood racial and\nethnic changes in the largest and one of the most diverse cities in the\nUnited States, New York City, using longitudinal census data up to the\nlatest 2020 decennial release. This notebook showcases a workflow that\nintroduces sequence analysis to the study of multidimensional\nneighborhood changes. We begin by processing the raw longitudinal census\ndata, then performing a k-means classification, and finally classify and\nmap sequences clusters. Our case study illustrates the gradual\nprogression that neighborhoods follow in when undergoing racial and\nethnic transformations. We observe an overall decline in the share of\nneighborhoods categorized by a large White majority population, in\nexchange for increasing diversity, especially Hispanic and Asian\npopulations.\n\n## Computational environment {#sec-compEnv}\n\nThe main libraries used in this paper include `dplyr` for processing\ntabular census data, `sf` for mapping the resulting clusters, `cluster`\nfor performing the `k-means` cluster analysis. Finally, to perform the\nsequence analysis, we use `TraMineR` [@gabadinho2011analyzing]. This is\na popular and continually updated R package for performing sequence\nanalysis for a host of social science applications, including analyses\nof neighborhood change [@Delmelle2016; @delmelle2017differentiating;\n@patias2020scalable].\n\n```{r loadlibraries, include = FALSE, warning=FALSE}\n# Set CRAN mirror\noptions(repos = c(CRAN = \"https://cloud.r-project.org/\"))\n\n# For data management\nif (!require('knitr')) install.packages('knitr'); library('knitr')\nif (!require('rmarkdown')) install.packages('rmarkdown'); library('rmarkdown')\nif (!require('dplyr')) install.packages('dplyr'); library('dplyr')\n\n#for reading in data\nif (!require('here')) install.packages('here'); library('here')\n\n#for reading in census data\nif (!require('tidycensus')) install.packages('tidycensus'); library('tidycensus')\nif (!require('tigris')) install.packages('tigris'); library('tigris')\noptions(tigris_class = \"sf\") # returns data in sf format\n\n#for data table formatting\nif (!require('knitr')) install.packages('knitr'); library('knitr')\n\n#for data table pivoting\nif (!require('tidyverse')) install.packages('tidyverse'); library('tidyverse')\n\n\n#mapping packages\nif (!require('sp')) install.packages('sp'); library('sp')\nif (!require('sf')) install.packages('sf'); library('sf')\n\n#For data visualization\nif (!require('ggplot2')) install.packages('ggplot2'); library('ggplot2')\n\n#for facet plots\nif (!require('gridExtra')) install.packages('gridExtra'); library('gridExtra')\n\n#For sequence clustering\nif (!require('TraMineR')) install.packages('TraMineR'); library('TraMineR')\n\n# For k-means and hierarchical cluster analysis\nif (!require('cluster')) install.packages('cluster'); library('cluster')\n\n#For visualizing k-means outputs\nif (!require('factoextra')) install.packages('factoextra'); library('factoextra')\n\n# For creating heat map to describe k-means cluster results\nif (!require('pheatmap')) install.packages('pheatmap'); library('pheatmap')\n\n# For creating heat map to describe k-means cluster results\nif (!require('RColorBrewer')) install.packages('RColorBrewer'); library('RColorBrewer')\n\n# Other packages (cowplot:inset maps; extrafont for additional sans serif fonts)\nif (!require('cowplot')) install.packages('cowplot'); library('cowplot')\nif (!require('patchwork')) install.packages('patchwork'); library('patchwork')\nif (!require('extrafont')) install.packages('extrafont'); library('extrafont')\nloadfonts(device = \"win\") \nif (!require('ggspatial')) install.packages('ggspatial'); library('ggspatial')\nloadfonts(device = \"win\") \n```\n\n## Data {#sec-data}\n\nWe use decennial census tract data to examine neighborhood racial and\nethnic changes. Census tracts serve as imperfect, yet well-used\nneighborhood proxies. Census tract boundaries change over time, further\ncomplicating the study of population dynamics within these boundaries.\nThere are several sources of data that have been harmonized using\ninterpolation techniques to a consistent set of boundaries over time. We\nuse the Longitudinal Tract Database (LTDB) which uses areal and\npopulation interpolation techniques alongside ancillary data on water\ncover to derive estimates [@logan2014interpolating]. Analyses of the\nerrors produced by three popular longitudinal data providers suggest\nthat LTDB performs similarly to the dataset produced by the National\nHistoric Geographic Information System (NHGIS) and both perform better\nthan the Neighborhood Change Database which relies solely on areal\ninterpolation without the inclusion of ancillary data\n[@logan2014interpolating]. Therefore, for this type of analysis either\nthe LTDB or NHGIS would be suitable dataset for this analysis.\n\nWe obtained the full count decennial data from LTDB from 1980-2020 from\nthe [Diversity and Disparties project at Brown\nUniversity](https://s4.ad.brown.edu/projects/diversity/Researcher/LTBDDload/DataList.aspx).\nThe census variables have been interpolated to 2010 tract boundaries.\nBecause the coding of census race and ethnicity changes over time, we\nopted to begin in 1980 as 1970, the earliest dataset available, did not\nrecord a count of Latino or Hispanic residents. The raw data contains\nall census tracts throughout the United States. For visualization\npurposes, we also import a shapefile of 2010 census tract boundaries\nusing the `tidycensus` package and setting the geometry to `true`.\n\n```{r importdata, warning=FALSE, cache = TRUE, message=FALSE}\nsetwd(here())  #current working directory\n\n#csv tables for longitudinal data\ncensus20<- read.csv(\"data/ltdb_std_2020_fullcount.csv\")\ncensus10<- read.csv(\"data/LTDB_Std_2010_fullcount.csv\")\ncensus00<- read.csv(\"data/LTDB_Std_2000_fullcount.csv\")\ncensus90<- read.csv(\"data/LTDB_Std_1990_fullcount.csv\")\ncensus80<- read.csv(\"data/LTDB_Std_1980_fullcount.csv\")\n\n#geometry data\n#filter for NYC counties (5 boroughs)\nnyc_counties <- c(\"Kings\", \"Queens\", \"New York\", \"Richmond\", \"Bronx\")\ntract <- get_decennial(geography = \"tract\",\n                       variables = \"P001001\",\n                       year = 2010,\n                       state = \"NY\",\n                       county = nyc_counties,\n                       geometry = TRUE,\n                       progress = FALSE)\n```\n\nWe next calculate the share of `White`, `Black`, `Hispanic`, and `Asian`\nresidents in each tract for each decade from the raw count using the\ntotal population as the denominator. We filter out tracts where the\npopulation is `0` and select only the relevant columns to create our\ndata frame. We then join all columns from the five decennial data frames\ninto one data frame called `census_all` and finally select only census\ntracts from the five counties that comprise New York City's five\nboroughs: Bronx County, Kings County (Brooklyn), New York County\n(Manhattan), Queens County, Richmond County (Staten Island).\n\n```{r calculatepercents, warning=FALSE, message=FALSE}\ncensus80 <- census80 %>% filter (POP80 >0)\ncensus80$perwhite80 <- census80$NHWHT80/census80$POP80\ncensus80$perblack80 <- census80$NHBLK80/census80$POP80\ncensus80$perhisp80 <- census80$HISP80/census80$POP80\ncensus80$perasian80 <- census80$ASIAN80/census80$POP80\ncensus80<- census80 %>% select(c(\"TRTID10\",\"perwhite80\", \"perblack80\", \"perhisp80\", \"perasian80\"))\n\ncensus90 <- census90 %>% filter (POP90 >0)\ncensus90$perwhite90 <- census90$NHWHT90/census90$POP90\ncensus90$perblack90 <- census90$NHBLK90/census90$POP90\ncensus90$perhisp90 <- census90$HISP90/census90$POP90\ncensus90$perasian90 <- census90$ASIAN90/census90$POP90\ncensus90<- census90 %>% select(c(\"TRTID10\",\"state\",\"county\",\"perwhite90\", \"perblack90\", \"perhisp90\", \"perasian90\"))\n\ncensus00 <- census00 %>% filter (POP00 >0)\ncensus00$perwhite00 <- census00$NHWHT00/census00$POP00\ncensus00$perblack00 <- census00$NHBLK00/census00$POP00\ncensus00$perhisp00 <- census00$HISP00/census00$POP00\ncensus00$perasian00 <- census00$ASIAN00/census00$POP00\ncensus00<- census00 %>% select(c(\"TRTID10\",\"perwhite00\", \"perblack00\", \"perhisp00\", \"perasian00\"))\n\ncensus10 <- census10 %>% rename(\"TRTID10\" = \"tractid\")\ncensus10$perwhite10 <- census10$nhwht10/census10$pop10\ncensus10$perblack10 <- census10$nhblk10/census10$pop10\ncensus10$perhisp10 <- census10$hisp10/census10$pop10\ncensus10$perasian10 <- census10$asian10/census10$pop10\ncensus10<- census10 %>% select(c(\"TRTID10\",\"perwhite10\", \"perblack10\", \"perhisp10\", \"perasian10\"))\n\ncensus20 <- census20 %>% rename(\"TRTID10\" = \"TRTID2010\")\ncensus20$perwhite20 <- census20$nhwt20/census20$pop20\ncensus20$perblack20 <- census20$nhblk20/census20$pop20\ncensus20$perhisp20 <- census20$hisp20/census20$pop20\ncensus20$perasian20 <- census20$asian20/census20$pop20\ncensus20<- census20 %>% select(c(\"TRTID10\",\"perwhite20\", \"perblack20\", \"perhisp20\", \"perasian20\"))\n\n#join all data frames from each decade\ncensus_all<- census90 %>% left_join(census00) %>% left_join(., census10) %>% left_join(., census20)%>% left_join(., census80)\n\n#Select NYC Counties. These include Bronx County, Kings County (Brooklyn), New York County (Manhattan), Queens County, Richmond County (Staten Island)\n\ncensus_select <- census_all %>% filter((state == \"NY\" & county == \"Bronx County\")|\n                              (state == \"NY\" & county == \"Kings County\")|\n                              (state == \"NY\" & county == \"New York County\")|\n                              (state == \"NY\" & county == \"Queens County\")|\n                              (state == \"NY\" & county == \"Richmond County\"))\n\n##remove NA values and state and county columns\ncensus_nyc <- na.omit(census_select)%>% select(-state, -county)\n\n#Select only the tractID column from the shapefile. Rename the field for ease of joining and convert to double to match the csv data.\ntract<- tract %>% select(\"GEOID\")\ntract<- rename(tract, TRTID10 = GEOID)\ntract$TRTID10<- as.double(tract$TRTID10)\n```\n\n```{r extract county boundaries, warning=FALSE, cache = TRUE, message=FALSE}\n# Set tigris options to return the data in sf format (spatial data frame)\noptions(tigris_class = \"sf\")\n\n# Download county boundaries for New York state\nny_counties <- counties(state = \"NY\", cb = TRUE,\n                         progress = FALSE)\n\n# Filter for only the New York City counties\nnyc_counties <- ny_counties %>%\n  filter(NAME %in% c(\"Bronx\", \"Kings\", \"New York\", \"Queens\", \"Richmond\"))\n\n# View the structure of the data\nprint(nyc_counties)\n```\n\n## Basic conceptual intuition {#sec-intuition}\n\nOur analysis features two fundamental steps. The first is the *k*-means\nclustering of the census tracts to derive multidimensional classes of\nneighborhoods containing similar racial and ethnic compositions.\n[@reibel2011neighborhood] introduced the idea of using an unsupervised\nclassification approach for studying neighborhood racial change as an\nalternative to the use of neighborhood diversity indices. The objective\nof the *k*-means algorithm is to group observations in such a way that\nmaximizes the similarity of observations within groups or clusters while\nmaximizing the dissimilarity between each cluster. In other words, the\ngoal is to group neighborhoods so that those most similar to each other\naccording to their racial and ethnic makeup are assigned to the same\ncluster and the clusters themselves are distinct from one another in\nterms of their makeup. With the *k*-means algorithm, the number of\nclusters, *k* must be determined *a priori*. To make this determination,\nit is customary to evaluate multiple solutions using various fit\nstatistics in conjunction with domain and geographic knowledge of the\ndata [@delmelle2015five]. It is also commonly recommended that input\nvariables first be normalized to avoid placing unequal emphasis on\nvariables that may be on different measurement scales. However, in our\ncase study, all of the racial and ethnic variables represent percentages\nof the population and so this step is not performed in the case study.\n\nOur ultimate goal is to understand the major pathways of neighborhood\nchange and so each neighborhood will be classified five times for 1980,\n1990, 2000, 2010, and 2020 to establish its longitudinal sequence. To\nensure that the clusters are temporally stable, we will perform the\nclustering for all years at once. New neighborhood typologies may emerge\nover time with this approach. In that instance, only tracts from the\nlater years would be assigned to the new cluster.\n\nLike *k*-means, sequence analysis is an unsupervised classification\ntechnique that aims to cluster similar longitudinal sequences. To\ndetermine the similarity of the sequences, a key step in this analysis\nis to create the dissimilarity measure. There are various approaches\nthat can be used to determine the similarity of categorical sequences.\n[@studer2016matters] provides a comprehensive overview of various\ntechniques for determining sequences dissimilarity for social science\napplications. In this case study, we are most interested in the\n*ordering* or *sequencing* of neighborhood cross-sectional racial\ngroups. Each neighborhood will have the same number of states, captured\nat the same decennial interval, which differs from studies of\nindividuals progressing through a series of life course events, for\nexample. In those cases, other considerations like the duration of time\nspent in each state or the timing of certain events may matter more in\nultimately grouping the sequences based on similarity. Here we aim to\ncreate clusters of sequences that follow a similar ordering of events -\nprogressing from example, a Majority White neighborhood through a Mixed\nRace state towards a Majority Hispanic state. The amount of time spent\nin each of these states might differ, but ultimately this describes\n*how* a neighborhood has changed over time. Given this, we follow\n[@delmelle2017differentiating] and use a variation on the popular\nOptimal Matching (OM) algorithm called OMstrans. The OM algorithm is a\nstring editing technique that determines the cost it would take to\ncompletely transform one sequence into another. This is achieved by\neither inserting, deleting, or substituting elements in one sequence\nuntil it matches another. For example, one neighborhood may have a\nsequence of *White*, *White*, *Mixed Race*, *Hispanic* while another\nneighborhood might follow the sequence *White*, *White*, *Mixed Race*,\n*Mixed Race*. Between these two strings, there is one entry that\ndiffers: the final state. To transform one to another, we could\nsubstitute *Hispanic* for *Mixed Race* in the second sequence, and the\ndissimilarity of the two sequences would be equal to the cost of that\nsubstitution. In the OMstrans variant, distances between sequences of\ntransitions are computed. This means that each state is merged with its\nprevious state to create a subsequence. In the previous illustrative\nexample, the first sequence becomes (*White-White*, *White-MixedRace*,\n*MixedRace-Hispanic*) and the OM cost evaluation is then applied to\nthese subsequences. This helps to ensure that the ordering of events is\npreserved in the sequence clusters. The importance given to the\npreservation of ordering is governed by the parameter *w*, the\norigin-transition parameter. When *w* = 1, OMstrans approximates the\ntraditional OM algorithm. A lower value places greater emphasis on the\nordering or sequencing of events.\n\n## Application {#sec-application}\n\n### Study Area\n\nOur study area consists of census tracts within the five Boroughs of New\nYork (see Figure below for an overview map).\n\n```{r visualize-area, warning=FALSE, cache=TRUE, message=FALSE, fig.cap=\"Overview map of New York City's five boroughs and surrounding counties\", fig.width=10, fig.height=8}\n\n# Filter for only the New York City counties\nnyc_counties <- ny_counties %>%\n  filter(NAME %in% c(\"Bronx\", \"Kings\", \"New York\", \"Queens\", \"Richmond\")) \n\n# Modify labels for specific counties\nnyc_counties$label_main <- ifelse(nyc_counties$NAME == \"New York\", \"New York\", \n                                  ifelse(nyc_counties$NAME == \"Kings\", \"Kings\",\n                                         ifelse(nyc_counties$NAME == \"Richmond\", \"Richmond\", \n                                                nyc_counties$NAME)))\n\nnyc_counties$label_paren <- ifelse(nyc_counties$NAME == \"New York\", \"(Manhattan)\", \n                                   ifelse(nyc_counties$NAME == \"Kings\", \"(Brooklyn)\",\n                                          ifelse(nyc_counties$NAME == \"Richmond\", \"(Staten Island)\", \n                                                 \"\")))\n\n# Calculate centroids for each county to get coordinates for labels\ncentroids <- st_centroid(nyc_counties)\ncoords <- st_coordinates(centroids)\n\n# Add the coordinates to the nyc_counties data frame\nnyc_counties <- nyc_counties %>%\n  mutate(X = coords[, 1],\n         Y = coords[, 2])\n\n# Adjust coordinates manually for specific counties\nnyc_counties <- nyc_counties %>% \n  mutate(\n    X = ifelse(NAME == \"New York\", X - 0.11, \n               ifelse(NAME == \"Richmond\", X + 0.012, X)), # Move \"New York\" left, Richmond right\n    Y = ifelse(NAME == \"New York\", Y + 0.005, \n               ifelse(NAME == \"Richmond\", Y + 0.03, Y)) # Adjust Richmond label higher\n  )\n\n#you can mask water area if you would like.\n#nyc_counties <- nyc_counties %>%  erase_water(area_threshold = 0.9)\n\n# Create the large map for the state without a scale bar\nzoomed_map <- ggplot() +\n  geom_sf(data = ny_counties, fill = \"gray85\", color = \"white\", size = 1) + # New York State outline\n  geom_sf(data = nyc_counties, fill = \"#85B0A9\", color = \"white\", size = 3) + # NYC counties in teal\n  geom_segment(aes(x = -73.98, y = 40.775, xend = -74.03, yend = 40.775), \n               color = \"gray25\", size = 0.5) + # Line from New York label to the boundary\n  geom_text(data = nyc_counties, aes(x = X, y = Y, label = label_main), \n            color = \"black\", size = 4, family = \"Arial\", fontface = \"bold\") + # Add main county names\n  geom_text(data = nyc_counties, aes(x = X, y = Y - 0.02, label = label_paren), \n            color = \"gray25\", size = 3.75, family = \"Arial\") + # Add parentheses labels in lighter color\n  geom_text(aes(x = -73.6, y = 40.725, label = \"Nassau\"), \n            color = \"gray55\", size = 4, family = \"Arial\", fontface = \"bold\") + # Corrected Nassau label position\n  geom_text(aes(x = -73.8, y = 40.98, label = \"Westchester\"), \n            color = \"gray55\", size = 4, family = \"Arial\", fontface = \"bold\") + # Corrected Westchester label\n  geom_text(aes(x = -73.6, y = 40.705, label = \"(Long Island)\"), \n            color = \"gray70\", size = 3.5, family = \"Arial\", fontface = \"bold\") + # Add Long Island label below Nassau\n  coord_sf(xlim = c(-74.25, -73.5), ylim = c(40.4, 41.05), expand = FALSE) + # Crop to focus on NYC\n  theme_minimal() +\n  theme(\n    panel.grid.major = element_blank(), # Remove major grid lines\n    panel.grid.minor = element_blank(), # Remove minor grid lines\n    axis.title = element_blank(), # Remove axis titles\n    axis.text = element_blank(), # Remove axis text (labels)\n    legend.position = \"none\", # Remove the legend\n    plot.margin = margin(0, 0, 0, 0) # Remove margins for a tighter crop\n  )\n\n# Create the large map for NY and surrounding counties with text annotation\ninset_map <- ggplot() +\n  geom_sf(data = ny_counties, fill = \"gray90\", color = NA, size = 1) + # All counties in gray, including Nassau and Westchester\n  geom_sf(data = nyc_counties, fill = \"#569289\", color = \"#569289\", size = 5) + # NYC counties in darker teal\n  annotate(\"text\", x = -76.2, y = 42.8, label = \"New York State\", \n           size = 5.25, color = \"gray49\", angle = 0, \n           alpha = 0.7, family = \"Arial\") + # Add text label\n  theme_minimal() +\n  theme(\n    panel.grid.major = element_blank(), # Remove major grid lines\n    panel.grid.minor = element_blank(), # Remove minor grid lines\n    plot.title = element_text(hjust = 0), # Align title to the left\n    plot.subtitle = element_text(hjust = 0), # Align subtitle to the left\n    axis.title = element_blank(), # Remove axis titles\n    axis.text = element_blank(), # Remove axis text (labels)\n    plot.margin = margin(0, 0, 0, 0) # Tighten margins\n  )\n\n# Combine the maps, placing the inset map within the zoomed-in map\nfinal_plot <- ggdraw() +\n  draw_plot(zoomed_map) +\n  draw_plot(inset_map, x = 0.07, y = 0.65, width = 0.3, height = 0.3) # Adjust position and size of the inset\n\n# Display the combined plot\nprint(final_plot)\n```\n\nTo begin our case study, we start by preparing the data for the\n*k*-means clustering. This involves pivoting the data frame so that each\ncensus tract is represented with five distinct rows, once for each\ndecennial value. To do so, we pivot from a wide to a long format and\nselect out just the four race and ethnicity values to be used in the\nclustering.\n\n```{r kmeans, warning=FALSE, cache=TRUE, message=FALSE}\n# Convert the data frame from wide to long format\ncensus_long <- census_nyc %>%\n  pivot_longer(cols = starts_with(\"per\"), \n               names_to = c(\".value\", \"year\"), \n               names_pattern = \"per(\\\\w+)(\\\\d{2})\") %>%\n  mutate(year = case_when(\n    year == \"80\" ~ 1980,\n    year == \"90\" ~ 1990,\n    year == \"00\" ~ 2000,\n    year == \"10\" ~ 2010,\n    year == \"20\" ~ 2020,\n    TRUE ~ as.integer(year)\n  ))\n\n\ndata_for_clustering <- census_long %>%\n  select(white, black, hisp, asian)\n```\n\nAs explained above, the *k*-means clustering procedure requires that the\nnumber of clusters, *k* be specified *a priori*. There are fit\nstatistics that attempt to determine the optimal number of clusters,\nconsidering the similarity of observations within each cluster and the\ndistinctiveness of the clusters from each other. However, these\nmathematically-derived solutions are devoid of any contextual or\ntheoretical understanding of the problem under study. Therefore, the\nselection of *k* often becomes more akin to art than a science\n[@von2012clustering], considering the objective of the study. We begin\nwith two common data-driven approaches that explore multiple clustering\nsolutions for different *k* values and then examines the *within sum of\nsquares* (WSS) and the *average silhouette score* for each solution. The\nWSS assesses how compact a clustering solution is, or how homogeneous\nthe observations assigned to each cluster are, and the average\nsilhouette score measures how well separated each cluster is from each\nother. Our objective is to derive a typology of neighborhoods according\nto their racial and ethnic makeup, for four groups: percent White,\nBlack, Hispanic, and Asian. The Figure below shows the results of the\nclustering analysis; the Elbow method plot suggests the optimal number\nof clusters, while the Silhouette method plot helps validate the cluster\nseparation.\n\n```{r kmeans1, warning=FALSE, cache=TRUE, message=FALSE}\n# Now do the k-means clustering on all\n\ndata_for_clustering <- census_long %>%\n  select(white, black, hisp, asian)\n\n# Function to calculate total within-cluster sum of squares for different k\nwss <- function(k) {\n  kmeans(data_for_clustering, k, nstart = 10)$tot.withinss\n}\n\n# Compute and plot wss for k = 1 to k = 10\nk.values <- 1:10\nwss_values <- map_dbl(k.values, wss)\n\n# Elbow method plot\nplot(k.values, wss_values, type = \"b\", pch = 19, frame = FALSE,\n     xlab = \"Number of clusters K\",\n     ylab = \"Total within-clusters sum of squares\")\n\n# Silhouette method for determining the optimal number of clusters\nfviz_nbclust(data_for_clustering, kmeans, method = \"silhouette\")\n```\n\n### Exploring *k*-means Cluster Solutions\n\nAccording to these plots, the mathematically optimal number of\nneighborhood clusters for racial makeup is three. We can further explore\nthe makeup of neighborhoods within these three clusters a few ways to\ndetermine if, in fact, three clusters provides a meaningful segmentation\nof four distinct racial and ethnic groups. In the plots below, we can\nvisualize the average silhouette value for each cluster. The\n*Silhouette* values range from -1 to 1; values close to 1 suggest that\nthe observations are well clustered while negative values suggest that\nan observation might be assigned to the wrong cluster. From the plot,\nClusters 2 and 3 appears to be the most cohesive clusters, with average\nsilhouette widths of 0.64, while cluster 1 has some potentially poorly\nclassified neighborhoods. Descriptions of the racial and ethnic makeup\nof the clusters are obtained from the associated stacked bar charts. We\ncan see that Cluster 1 is characterized as being nearly 50 percent\nHispanic, with near equal shares of Whites, Blacks, and Asians. Cluster\n2 is majority Black with approximately 15 percent Hispanics and few\nWhites and Asians. Finally, Cluster 3 is majority White. Therefore, this\nsegmentation provides us with clusters indicating the dominant racial\ngroups, but may miss some nuances of other racial and ethnic\nneighborhood compositions. We can therefore explore how increasing *k*\nmay portray a richer portrait of neighborhood demographic profiles. The\nFigure below illustrates the Silhouette Analysis to assess cluster\nseparation, and the demographic makeup of the three clusters (bottom\nFigure).\n\n```{r threeclusters, warning=FALSE, cache=TRUE, message=FALSE, fig.cap=\"Cluster Analysis Results: Silhouette Analysis and Cluster Demographic Makeup\"}\n# Assume the optimal number of clusters (k) is 3 from the previous steps\nset.seed(123)\nkmeans_result <- kmeans(data_for_clustering, centers = 3, nstart = 25)\n\n# Add the cluster assignments to the original data\ncensus_long$cluster <- kmeans_result$cluster\n\n# Silhouette Analysis\nsil <- silhouette(kmeans_result$cluster, dist(data_for_clustering))\nfviz_silhouette(sil)\n\n# Extract silhouette information to a data frame (df)\nsil_df <- as.data.frame(sil[, 1:3])\ncolnames(sil_df) <- c(\"Cluster\", \"Silhouette Width\", \"Neighboring Cluster\")\n\n# Cluster profiles\ncluster_profiles <- census_long %>%\n  group_by(cluster) %>%\n  summarise(across(c(white, black, hisp, asian), ~ round(mean(.), 2)))\n\n# Print the table as a formatted table\nkable(cluster_profiles, caption = \"Cluster Profiles: Average Demographics\", \n      col.names = c(\"Cluster\", \"White\", \"Black\", \"Hispanic\", \"Asian\"),\n      format = \"markdown\")\n\n# Reshape the data from wide to long format\ncluster_profiles_long <- cluster_profiles %>%\n  pivot_longer(cols = c(\"white\", \"black\", \"hisp\", \"asian\"), \n               names_to = \"Demographic\", values_to = \"Proportion\")\n\n# Create the stacked bar chart\nggplot(cluster_profiles_long, aes(x = factor(cluster), y = Proportion, fill = Demographic)) +\n  geom_bar(stat = \"identity\") +\n  labs(title = \"Cluster Demographic Makeup - 3 clusters\", x = \"Cluster\", y = \"Proportion\") +\n  scale_fill_brewer(palette = \"Set3\") +  # Adjust color palette if desired\n  theme_minimal()\n```\n\nNext, we compare 4, 5, and 6 cluster solutions. We can see that the\naverage silhouette of the solutions declines as the number of clusters\nincreases. The demographic profiles show several new neighborhood\ntypologies emerge with more clusters added. With a four cluster\nsolution, we observe neighborhood typologies for each of the three\ndominant racial and ethic groups: White, Hispanic, and Black along with\none mixed neighborhood type, shown in cluster 4. As expected, that\ncluster displays the lowest silhouette value, with some potentially\nmis-classified neighborhoods. The 5 cluster solution adds a cluster\nshowing a majority Asian population, alongside two majority White\npopulations - one showing more diversity than the other), and a majority\nBlack, and Hispanic group. Finally, a 6 cluster solution shows more\nracially mixed groups, but at the expense of less well-defined or\nseparated clusters. In the code below, each variable name ends with a\nnumber (4, 5 or 6), indicating which number of clusters (k) it\nrepresents. The results displays the silhouette analysis results for\nclustering into (a) four clusters, (b) five clusters, and (c) six\nclusters, illustrating the cohesion and separation of clusters at\ndifferent sizes.\n\n```{r silhouette-plots, warning=FALSE, cache=TRUE, message=FALSE,  fig.cap=\"Silhouette Analysis for Different Cluster Sizes: (top) Four Clusters, (middle) Five Clusters, and (bottom) Six Clusters.\"}\n# Perform k-means clustering for 4, 5, and 6 clusters\nset.seed(123)\nkmeans_4 <- kmeans(data_for_clustering, centers = 4, nstart = 25)\nkmeans_5 <- kmeans(data_for_clustering, centers = 5, nstart = 25)\nkmeans_6 <- kmeans(data_for_clustering, centers = 6, nstart = 25)\n\n# Add cluster assignment to original data\ncensus_long$cluster_4 <- kmeans_4$cluster\ncensus_long$cluster_5 <- kmeans_5$cluster\ncensus_long$cluster_6 <- kmeans_6$cluster\n\n# Silhouette analysis for 4, 5, and 6 clusters\nsil_4 <- silhouette(kmeans_4$cluster, dist(data_for_clustering))\nsil_5 <- silhouette(kmeans_5$cluster, dist(data_for_clustering))\nsil_6 <- silhouette(kmeans_6$cluster, dist(data_for_clustering))\n\n# Plot silhouette for 4 clusters\nplot_4 <- fviz_silhouette(sil_4) + ggtitle(\"Silhouette Plot - Four Clusters\")\n\n# Plot silhouette for 5 clusters\nplot_5 <- fviz_silhouette(sil_5) + ggtitle(\"Silhouette Plot - Five Clusters\")\n\n# Plot silhouette for 6 clusters\nplot_6 <- fviz_silhouette(sil_6) + ggtitle(\"Silhouette Plot - Six Clusters\")\n\n# Combine the three plots into a faceted view\ngrid.arrange(plot_4, plot_5, plot_6, ncol = 1)\n```\n\nThe figure illustrates the demographic composition of clusters for\ndifferent clustering solutions: (a) four clusters, (b) five clusters,\nand (c) six clusters, highlighting how demographic groups are\ndistributed across various cluster labels.\n\n```{r explore-demographics, warning=FALSE, cache=TRUE, message=FALSE, fig.cap=\"Geographic variation of Labeled Clusters for Different Clustering Solutions.\"}\n# We need to hard code the labels to be able to compare the demographic profile of each solution. This is because R randomly assigns the label each time, even if the clustering solution is the same because we set the seed.\nlabel_clusters <- function(cluster_profiles) {\n  cluster_profiles %>%\n    mutate(\n      label = case_when(\n        white > 0.75 ~ \"3 White\",\n        hisp > 0.45 ~ \"2 Hispanic\",\n        black > 0.75 ~ \"1 Black\",\n        asian > 0.45 ~ \"5 Asian\",\n        white < 0.56 & hisp > 0.20 & black < 0.20 ~ \"4 Mixed\",\n        black > 0.49 & hisp > 0.25 & white < 0.15 ~ \"6 Black and Hispanic\",\n        TRUE ~ \"Other\"  # Default label if none of the conditions are met\n      )\n    )\n}\n\n# Create cluster profiles and label them according to your custom rules\ncluster_profiles_4 <- census_long %>%\n  group_by(cluster_4) %>%\n  summarise(across(c(white, black, hisp, asian), ~ round(mean(.), 2))) %>%\n  mutate(`Clustering_Solution` = \"4 Clusters\", Cluster = cluster_4) %>%\n  label_clusters()\n\ncluster_profiles_5 <- census_long %>%\n  group_by(cluster_5) %>%\n  summarise(across(c(white, black, hisp, asian), ~ round(mean(.), 2))) %>%\n  mutate(`Clustering_Solution` = \"5 Clusters\", Cluster = cluster_5) %>%\n  label_clusters()\n\ncluster_profiles_6 <- census_long %>%\n  group_by(cluster_6) %>%\n  summarise(across(c(white, black, hisp, asian), ~ round(mean(.), 2))) %>%\n  mutate(`Clustering_Solution` = \"6 Clusters\", Cluster = cluster_6) %>%\n  label_clusters()\n\n# Combine all cluster profiles into one table\ncluster_profiles_combined <- bind_rows(cluster_profiles_4, cluster_profiles_5, cluster_profiles_6)\n\n# Map the labels back to the original tracts by joining based on cluster assignments\ncensus_long <- census_long %>%\n  left_join(cluster_profiles_4 %>% select(Cluster, label) %>% rename(label_4 = label), by = c(\"cluster_4\" = \"Cluster\")) %>%\n  left_join(cluster_profiles_5 %>% select(Cluster, label) %>% rename(label_5 = label), by = c(\"cluster_5\" = \"Cluster\")) %>%\n  left_join(cluster_profiles_6 %>% select(Cluster, label) %>% rename(label_6 = label), by = c(\"cluster_6\" = \"Cluster\"))\n\n# Reshape data for plotting\ncluster_profiles_long <- cluster_profiles_combined %>%\n  pivot_longer(cols = c(\"white\", \"black\", \"hisp\", \"asian\"),\n               names_to = \"Demographic\", values_to = \"Proportion\")\n\n# Plot stacked bar charts of demographic makeup for each labeled cluster\nggplot(cluster_profiles_long, aes(x = label, y = Proportion, fill = Demographic)) +\n  geom_bar(stat = \"identity\", position = \"stack\") +\n  facet_grid(Clustering_Solution ~ ., scales = \"free_x\") +  # Facet vertically by clustering solution\n  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +\n  labs(\n    title = \"\",\n    x = \"Cluster Label\",\n    y = \"Proportion of Demographic Group\",\n    fill = \"Demographic Group\"\n  ) +\n  theme_minimal() +\n  theme(\n    axis.text.x = element_text(angle = 45, hjust = 1),\n    plot.title = element_text(hjust = 0.5)\n  )\n```\n\nWe can explore how this plays out for a specific observation. For\nexample, take the first census tract in the data frame for the year\n`2020`. This tract's racial composition was `58%` Black and `30%`\nHispanic with small shares of Whites and Asians. With the four cluster\nsolution, this tract was classified into class 1, `Majority Black`. For\nthe five cluster solution, it was also classified as `Majority Black`,\nand for the six cluster solution, `Black and Hispanic`. In 1990, that\nsame tract was `34%` black and `61%` Hispanic, resulting in the tract\nbeing classified as `Majority Hispanic` by all three clustering\nsolutions. When looking at change over time, the neighborhood will\neither be registered as transitioning from `Majority Hispanic` to either\n`Majority Black` or `Black and Hispanic`, depending on the final cluster\nsolution. In this instance, the 6 cluster solution provides a more\naccurate portrayal of the dynamics - while the neighborhood did\ntechnically become majority Black, there is still a significant Hispanic\npresence, a detail that would have been omitted by limiting the number\nof groups.\n\nFinally, we can examine the spatial distribution of these clustering\nsolutions to help aid in the final determination for the sequence\nanalysis. Since we did the cluster analysis on all decades, for this\npurpose, we will contrast the 4, 5, and 6 cluster solutions just for\n2020. All three maps depict a similar spatial pattern, but with a more\nfragmented pattern in the case of the 6 cluster solution. For example,\nthe first two maps show contiguous tracts of the predominantly Black\ncluster, but the third map shows the emergence of the\n`Black and Hispanic` group largely forming on the outskirts of this\nspatial cluster. Another aparent distinction is the large spatial\ncluster of the `Asian` cluster in Queens, which had been labeled as\n`Mixed` in the 4 cluster solution.\n\nTo better understand details on racial neighborhood transitions, we will\ngo with the larger number of clusters, 6, despite the mathematical\npreference for a 3 cluster solution. Our result illustrates the\ndemographic distribution of labeled clusters for different clustering\nsolutions: four clusters, five clusters, and six clusters.\n\n```{r demographic-distribution, warning=FALSE, cache=TRUE, message=FALSE, fig.cap=\"Demographic Distribution of Labeled Clusters for Different Clustering Solutions: Four Clusters (top), Five Clusters (middle), and Six Clusters (bottom).\"}\n# Filter data for the year 2020 and merge labels with tract data for mapping\ntract_clusters_2020 <- tract %>% erase_water(area_threshold = 0.9) %>%\n  left_join(census_long %>%\n              filter(year == 2020) %>%  # Filter for the year 2020\n              select(TRTID10, cluster_4, cluster_5, cluster_6, label_4, label_5, label_6), by = \"TRTID10\") %>%\n  pivot_longer(cols = c(\"cluster_4\", \"cluster_5\", \"cluster_6\"),\n               names_to = \"ClusterSolution\", values_to = \"Cluster\") %>%\n  pivot_longer(cols = c(\"label_4\", \"label_5\", \"label_6\"),\n               names_to = \"LabelSolution\", values_to = \"Label\") %>%\n  filter(str_replace(ClusterSolution, \"cluster_\", \"\") == str_replace(LabelSolution, \"label_\", \"\")) %>%\n  mutate(Label = factor(Label)) %>%\n  mutate(ClusterSolution = recode(ClusterSolution,\n                                  \"cluster_4\" = \"4 Clusters\",\n                                  \"cluster_5\" = \"5 Clusters\",\n                                  \"cluster_6\" = \"6 Clusters\")) %>%\n  mutate(ClusterSolution = factor(ClusterSolution, levels = c(\"4 Clusters\", \"5 Clusters\", \"6 Clusters\")))\n\n# Create the base plot with the labeled clusters\nbase_plot <- ggplot(tract_clusters_2020) +\n  geom_sf(aes(fill = Label), color = NA) +  # Use the Label field for fill\n  geom_sf(data = nyc_counties, fill = NA, color = \"black\", size = 0.5) +  # Add county outlines\n  facet_wrap(~ ClusterSolution, nrow = 1) +  # Facet horizontally by clustering solution\n  scale_fill_manual(\n    values = c(\"3 White\" = \"#F0E442\", \"2 Hispanic\" = \"#D55E00\", \n               \"1 Black\" = \"#0072B2\", \"5 Asian\" = \"#CC79A7\", \n               \"4 Mixed\" = \"#009E73\", \"6 Black and Hispanic\" = \"#56B4E9\"),\n    labels = c(\"Black\", \"Hispanic\", \"White\", \"Asian\", \"Mixed\", \"Black and Hispanic\")  # Remove numbers from labels\n  ) +\n  labs(x = \"\", y = \"\", fill = NULL) +  # Remove the title and set fill to NULL to remove \"Label\"\n  theme_void() +\n  theme(\n    strip.text = element_text(hjust = .5, vjust = .1, face = \"italic\", size = 12),  # Center facet labels\n    legend.position = \"bottom\",  # Place the legend at the bottom\n    legend.title = element_blank(),  # Ensure legend title is blank\n    legend.text = element_text(size = 8)\n  ) +\n  guides(fill = guide_legend(nrow = 1, byrow = TRUE, label.position = \"bottom\"))  # Place category names under the boxes\n\n# Display the plot\ngrid.arrange(base_plot)\n```\n\nWe can begin with a simple exploration of the spatial changes over time\nin the maps showing the six clusters from 1980-2020 in a series of small\nmultiples. From these maps, we can pick out some general spatial\npatterns over time. For example, we can see the expanse of neighborhoods\nclassified as majority White from 1980 significantly diminishes by 2020.\nThe share of Hispanics is shown to increase over time in the northern\nsections of the City. Towards the East, we see neighborhoods generally\ntransition from predominantly White in 1980 to White and Mixed Race and\neventually to Asian by 2020. There are also some evident stable\nclusters. For instance, the two clusters of predominantly black\nneighborhoods in the South and Southeast appear quite table over time.\nHowever, the cluster of majority Black neighborhoods in towards the\nnorth of Manhattan is diminished, replaced by a Black and Hispanic\nclassification.\n\n```{r smallmultiples,warning=FALSE, cache=TRUE, message=FALSE, fig.show='hold', fig.cap=\"Change in the cluster memmbership over five decades\"}\ndecades <- c(1980, 1990, 2000, 2010, 2020)\n  \n# Filter and prepare data for mapping\ntract_clusters_decades <- tract %>%\n  left_join(census_long %>%\n              select(TRTID10, year, label_6), by = \"TRTID10\") %>%\n  filter(!is.na(label_6)) \n\n# Set factor levels for year to ensure proper ordering\ntract_clusters_decades <- tract_clusters_decades %>%\n  mutate(year = factor(year, levels = decades))\n\n# Plot faceted maps for each decade (year)\nggplot(tract_clusters_decades) +\n  geom_sf(aes(fill = label_6), color = NA) +  # Use factor to ensure proper color assignment\n  geom_sf(data = nyc_counties, fill = NA, color = \"black\", size = 0.5) +  # Add county outlines\n  facet_wrap(~ year, ncol = 5) +  # Facet by year with 5 columns\n  scale_fill_manual(\n    values = c(\"3 White\" = \"#F0E442\", \"2 Hispanic\" = \"#D55E00\", \"1 Black\" = \"#0072B2\",\n               \"5 Asian\" = \"#CC79A7\", \"4 Mixed\" = \"#009E73\", \"6 Black and Hispanic\" = \"#56B4E9\"),\n    labels = c(\"Black\", \"Hispanic\", \"White\", \"Asian\", \"Mixed\", \"Black and Hispanic\"),  # Remove numbers from labels\n    name = \"\"  # Remove legend title\n  ) +\n  labs(title = \" \", x = \"\", y = \"\") +\n  theme_void() +\n  theme(\n    plot.title = element_text(hjust = 0, color = \"gray\"),  # Set the title color to gray\n    legend.position = \"bottom\",  # Move legend to the bottom\n    legend.direction = \"horizontal\",  # Make the legend horizontal\n    legend.title = element_blank(),  # Ensure the legend title is blank\n    legend.key.size = unit(0.6, \"cm\"),  # Set consistent size for legend boxes\n    legend.key.height = unit(0.6, \"cm\"),  # Set consistent height for legend boxes\n    legend.key.width = unit(0.5, \"cm\")  # Set consistent width for legend boxes\n  ) +\n  guides(\n    fill = guide_legend(\n      nrow = 1, byrow = TRUE, label.position = \"bottom\"  # Place category names under the legend boxes\n    )\n  )\n```\n\n### Sequence Analysis\n\nOur objective with the sequence classification is to come up with a\ntypology of neighborhood sequences over time to describe general\npathways of change. Each neighborhood has a sequence of classes over\ntime, one of 6 categorical groups for each of the five decennial census\nvalues from 1980-2020. The first step in the analysis is to convert the\ndata frame into a sequence for each neighborhood. We can see an\nillustrative example of the longitudinal sequences from the first five\nrecords. Classes are separated by a dash (-). There are 2122 sequences\nin the dataset and 197 unique sequences; all sequences are displayed in\nthe plot below. Thus, the purpose of clustering the sequences is to\nextract the general patterns present from the set of all sequences.\n\n```{r createsequences, warning=FALSE, cache=TRUE, message=FALSE, fig.cap=\"Sequence of each neighborhood.\"}\n# Convert the data from long to wide format to have a sequence for each neighborhood\n# Assuming census_long is your data frame\ncensus_wide <- tract_clusters_decades %>%\n  st_drop_geometry() %>%\n  select(TRTID10, year, label_6) %>%\n  pivot_wider(names_from = year, values_from = label_6)\n\n# Rename the columns to show only the year (remove \"cluster_\" prefix if it was added during previous steps)\ncolnames(census_wide) <- sub(\"cluster_\", \"\", colnames(census_wide))\n\n# Ensure columns are in the correct order by year\ncensus_wide <- census_wide %>%\n  select(TRTID10, `1980`, `1990`, `2000`, `2010`, `2020`)\n\n# Ensure the sequence columns are factors\ncensus_wide <- census_wide %>%\n  mutate(across(starts_with(\"19\") | starts_with(\"20\"), as.factor))\n\n# Check the distinct states (categories) in your sequences\nunique_states <- unique(unlist(census_wide[, -1]))  # Exclude TRTID10 column\nnum_states <- length(unique_states)\nprint(unique_states)\nprint(num_states)  # Number of unique states\n\n# Define the custom color palette with the correct colors\ncustom_palette <- c(\n  \"1 Black\" = \"#0072B2\",\n  \"2 Hispanic\" = \"#D55E00\",\n  \"3 White\" = \"#F0E442\",\n  \"4 Mixed\" = \"#009E73\",\n  \"5 Asian\" = \"#CC79A7\",\n  \"6 Black and Hispanic\" = \"#56B4E9\"\n)\n\n\n# Create the sequence object with the renamed columns\nsequence_data <- seqdef(census_wide[, -1], cpal = custom_palette)  # Exclude the TRTID10 column\n\n# Check the number of distinct sequences\nnum_sequences <- seqtab(sequence_data, idx = 0) %>% nrow\nprint(num_sequences)\n\n# Display the first few sequences\nhead(sequence_data)\n\n# Plot the sequences\nseqIplot(sequence_data,                                             # Sequence object\n         with.legend = \"right\",                                # Display legend on right side of plot\n         cex.legend = 0.6,                                     # Change size of legend\n         main = \"Neighborhood Racial and Ethnic Trajectories\") # Plot title\n```\n\nThe next objective is to compute the dissimilarity between all\nsequences. As described previously, we use the OMstrans algorithm to\npreserve the ordering of events as we are most interested in describing\nhow neighborhoods have generally transitioned over time. We set a low\nvalue (`0.1`) for the parameter `otto` in the `seqdist` command which is\nthe origin-transition trade-off weight. This emphasizes the ordering of\nsequence states. We also set a high `indel` cost of `3`. Finally,\nsubstitution costs are a function of the transition rate `TRATE` between\nstates. This places a lower cost on more frequent transitions.\n\nOnce the cost matrix is established, we then cluster the sequences using\nthe dissimilarity matrix as an input to generate the typology. We follow\nan iterative process in determining the optimal solution like the one\ndescribed above for the *k* means clustering. In short, multiple\nsolutions are tested and the resulting sequence clusters are visualized\nto inspect for heterogeneity. Because our clustering and distance matrix\nare optimized for describing transitions over time, we end up with one\ncluster that contains all neighborhoods that remained constant over\ntime. These sequences are very different from one another in the\nneighborhood types they describe, but they all represent a pathway or\nsequences of no change.\n\nTo describe the resulting sequence clusters, we plot a Sequence\nFrequency Plot for each cluster. We settled on 14 trajectory clusters\ndescribing neighborhood racial and ethnic transitions from 1980 to 2020\nin New York City. The Sequence Frequency Plots illustrate the sequences\nbelonging to each cluster and the sequence bars are scaled to visualize\nthe frequency of each sequence. A summary of the trajectories is as\nfollows:\n\n1.  Hispanic Majority to Black and Hispanic\n2.  Stability Cluster\n3.  White and Mixed Race to Hispanic Majority\n4.  White to White and Mixed Race to Hispanic Majority\n5.  Black and Hispanic to Hispanic Majority\n6.  White Majority to White and Mixed Race\n7.  White and Mixed Race to Black and Hispanic\n8.  Black and Hispanic to Black Majority\n9.  White and Mixed Race to Asian Majority\n10. White and Mixed Race to White Majority\n11. Black and Hispanic to White and Mixed Race\n12. White and Mixed Race to Asian Majority\n13. Black Majority to Black and Hispanic\n14. Black and Hispanic to Asian Majority\n\n```{r clustersequences, warning=FALSE, cache=TRUE, message=FALSE}\n# Pass this palette to seqdef\n# Define sequence data with custom color palette\nsequence_data <- seqdef(census_wide[, -1], cpal = custom_palette)  # Exclude the TRTID10 column\n\n# Compute Optimal Matching (OM) distances using the TRATE cost method\ncosts <- seqcost(sequence_data, method = \"TRATE\")\nom_distances <- seqdist(sequence_data, method = \"OMstran\", indel = 3, sm = costs$sm, otto = 0.1)\n\n# Perform hierarchical clustering using Ward's method on the OM distances\nclusterward <- agnes(om_distances, diss = TRUE, method = \"ward\")\n\n# Define the number of clusters and assign clusters to the sequence data\nnum_clusters <- 14\nclusters <- cutree(clusterward, k = num_clusters)\ncensus_wide$sequence_cluster <- clusters\n\n# Define cluster names for reference\ncluster_names1 <- c(\n  \"1 Black & Hispanic to Hispanic Majority\", \n  \"2 Stability\", \n  \"3 White Mixed Race to Hispanic\", \n  \"4 White to Mixed Race to Hispanic Majority\", \n  \"5 Majority White to Increasing Diversity\"\n)\n\n# Plot sequences for clusters in groups, adjusting legend settings\nplot_sequence_clusters <- function(cluster_range) {\n  seqfplot(\n    sequence_data[census_wide$sequence_cluster %in% cluster_range, ], \n    group = census_wide$sequence_cluster[census_wide$sequence_cluster %in% cluster_range], \n    sortv = \"from.start\", \n    border = NA, \n    with.legend = \"right\",         # Place the legend on the right\n    legend.prop = 0.2,             # Set the proportion of the plot area for the legend\n    legend.border = FALSE          # Remove the border around the legend\n  )\n}\n\n# Plot sequences for specified cluster ranges\nplot_sequence_clusters(1:2)\nplot_sequence_clusters(3:4)\nplot_sequence_clusters(5:6)\nplot_sequence_clusters(7:8)\nplot_sequence_clusters(9:10)\nplot_sequence_clusters(11:12)\nplot_sequence_clusters(13:14)\n```\n\nOf these 14 pathways, there are 3 that lead to the formation of a\nneighborhood transitioning into a Hispanic Majority cluster by 2020.\nThis includes Cluster 3 - showing neighborhoods that went from being a\nslight majority White, but with a mixture of other races in 1980 and\n1990 to transitioning to majority Hispanic by 1990 or 2000. Some of\nthese sequences indicate a continued transition towards becoming\nmajority Asian in the later years. Further segmenting the sequences into\nmore clusters may have separated out those trajectories, but for the\nsake of brevity, we leave them mixed in. Spatially, these are shown in\norange on the map below and can be see clustered in Staten Island,\nQueens, and in the Northern portion of the city. They are also notably\nadjacent to neighborhoods indicated by the red color, those representing\nsequence cluster 4, transitioning from majority White to White and Mixed\nRace and then to Majority Hispanic. This latter cluster might represent\nthe precursor to cluster 3, but are neighborhoods that made this\ntransition from majority White later, where the changes took time to\nspatially spillover to adjacent neighborhoods, as indicated by the map.\nBoth of these pathways depict a transition from largely White\npopulations to largely Hispanic.\n\nThe third pathway depicting a transition to majority Hispanic is\ndistinct. It is represented by cluster 5 showing a transition from\neither majority Black neighborhoods towards a mixed Hispanic and Black\ngroup and eventually majority Hispanic or, beginning the 1980 time\nstamp, in a more mixed Black and Hispanic state. Geographically, these\nneighborhoods are shown more in the northern sections of Manhattan and\nthe Bronx.\n\nFrom these two sets of sequence clusters, we can see that majority\nHispanic neighborhoods in New York City have emerged out of either\nmajority Black or Majority White neighborhoods over time.\n\n```{r transition, fig.cap=\"Neighborhoods Following Pathway to Hispanic Majority with White County Borders.\", echo=FALSE, warning=FALSE, message=FALSE}\n# Define the Hispanic majority clusters for plotting\nhispanic_majority_clusters <- census_wide %>%\n  filter(sequence_cluster %in% c(4, 5, 6))  # Filter clusters 4, 5, and 6\n\n# Join the filtered data with the tract shapefile based on TRTID10\ntract_hispanic_majority <- tract %>%\n  left_join(hispanic_majority_clusters, by = \"TRTID10\") %>% erase_water(area_threshold = 0.75)\n\n# Add county borders and color to the plot\nggplot(tract_hispanic_majority) +\n  geom_sf(aes(fill = factor(sequence_cluster)), color = NA) +  # Map sequence clusters\n  geom_sf(data = nyc_counties, fill = NA, color = \"black\", size = 0.5) +  # Add white county borders\n  scale_fill_manual(values = c(\"#FB8072\", \"#80B1D3\", \"#FDB462\"),  # Custom color palette\n                    labels = c(\"3 White - White, Mixed Race - Hispanic\", \n                               \"5 Black - Black & Hispanic - Hispanic\", \n                               \"4 White, Mixed Race - Hispanic\"), \n                    name = \"Hispanic Majority Pathway\") +\n  labs(title = \"\", \n       x = \"\", y = \"\") +\n  theme_void() +\n  theme(legend.position = \"right\",  # Place legend on the right\n        legend.direction = \"vertical\",  # Arrange legend items vertically\n        legend.title = element_text(size = 12),  # Customize legend title size\n        legend.key.width = unit(2, \"cm\"),  # Adjust legend key width\n        legend.box = \"vertical\")  # Place legend title on top of the legend\n```\n\nThere are also 3 pathways leading to an Asian majority neighborhood\ntype. These include clusters 9 and 12 which are also likely\ncontinuations of longer trajectories, that show a gradual transition\nfrom Majority White to White mixed race and eventually to Asian\nMajority. Geographically, these are clustered in the northern section of\nQueens. Sequence cluster 14 is more distinct in that the Asian majority\ntransitioned from the Black and Hispanic mixed group and spatially, they\nare generally located in upper Manhattan and the Bronx.\n\n```{r AsianPathways, fig.cap=\"Neighborhoods Following Pathway to Asian Majority\", echo=FALSE, warning=FALSE, message=FALSE}\n# Filter census data to include only clusters 14, 12, and 9 (Asian Majority Pathway clusters)\nasian_majority_clusters <- census_wide %>%\n  filter(sequence_cluster %in% c(14, 12, 9))  \n  \n# Join the filtered data with the tract shapefile (here, use TRTID10)\ntract_asian_majority <- tract %>% erase_water(area_threshold = 0.75) %>% \n  left_join(asian_majority_clusters, by = \"TRTID10\")  # Join with spatial data\n\n# Create a map of the neighborhoods with clusters 14, 12, and 9 with new labels\nggplot(tract_asian_majority) +\n  geom_sf(aes(fill = factor(sequence_cluster)), color = NA) +  # Map sequence clusters\n  geom_sf(data = nyc_counties, fill = NA, color = \"black\", size = 0.5) +  # Add white county borders\n  scale_fill_manual(values = c(\"#8DD3C7\", \"#FFFFB3\", \"#BEBADA\"),  # Custom color palette for Asian Majority clusters\n                    labels = c(\"14 White, Mixed Race to Black & Hispanic to Asian Majority\", \n                               \"12 White Majority to White Mixed Race to Asian\", \n                               \"9 White Mixed Race to Asian\"), \n                    name = \"Asian Majority Pathway\") +\n  labs(title = \"\", \n       x = \"\", y = \"\") +\n  theme_void() +\n  theme(legend.position = \"right\",  # Place legend at the bottom\n        legend.direction = \"vertical\",  # Arrange legend items horizontally\n        legend.title = element_text(size = 12),  # Customize legend title size\n        legend.key.width = unit(2, \"cm\"),  # Adjust legend key width\n        legend.box = \"vertical\")  # Place legend title on top of the legend\n```\n\n```{r whiteandblack}\n# Filter data for Increasing White (clusters 10 and 11)\nincreasing_white_clusters <- census_wide %>% \n  filter(sequence_cluster %in% c(10, 11))  # Clusters 10 and 11 for increasing White\n\n# Filter data for Increasing Black (clusters 1 and 8)\nincreasing_black_clusters <- census_wide %>%\n  filter(sequence_cluster %in% c(1, 8))  # Clusters 1 and 8 for increasing Black\n\n# Join the filtered data with the tract shapefile for each group\ntract_increasing_white <- tract %>%  erase_water(area_threshold = 0.75) %>%\n  left_join(increasing_white_clusters, by = \"TRTID10\")  # Join spatial data for increasing White\n\ntract_increasing_black <- tract %>%   erase_water(area_threshold = 0.75) %>%\n  left_join(increasing_black_clusters, by = \"TRTID10\")  # Join spatial data for increasing Black\n```\n\nThere are two pathways for increasing both Black and White shares in a\nneighborhoods. Neighborhoods that became increasingly White either\nfollowed a trajectory from White mixed race to majority White (Cluster\n10) or from either all Black or Black and Hispanic to White and Mixed\nrace (11). Notably, this transition largely took place within the past\n1-2 decades, aligning with when gentrification trends became accentuated\nin some cities, including New York. We see a clear cluster of this\nlatter group in Brooklyn, a borough whose gentrification trends have\nbeen well documented [@chronopoulos2020s; @halasz2023between].\n\nFor the case of increasing Black populations, Cluster 1 shows a pathway\nfrom Hispanic majority to mixed Black and Hispanic and Cluster 8 shows a\ngradual transition from Black and Hispanic to majority Black; a trend\nthat largely begin towards the middle of the study period, around the\n2000 census data mark. Spatially, the former is more dispersed, while\nthe latter is depicted more clearly in the southern neighborhoods of\nBrooklyn.\n\n```{r WhitePathways, fig.cap=\"Neighborhoods Following Pathway to White Majority\", echo=FALSE, warning=FALSE, message=FALSE}\n# Adjust plotting settings to improve map visibility\n# Create the map for Increasing White, zoomed in on the five boroughs\nggplot(tract_increasing_white) +\n  geom_sf(aes(fill = factor(sequence_cluster)), color = NA) +  # Map sequence clusters\n  geom_sf(data = nyc_counties, fill = NA, color = \"black\", size = 0.5) +  # Add white county borders\n  scale_fill_manual(values = c(\"#8DD3C7\", \"#FFFFB3\"),  # Custom color palette for White clusters\n                    labels = c(\"White Mixed Race to Majority White\", \n                               \"Black and Hispanic to White Mixed Race\"), \n                    name = \"Increasing White Pathway\") +\n  coord_sf(xlim = c(-74.3, -73.7), ylim = c(40.5, 40.9), expand = FALSE) +  # Zoom into the NYC area\n  theme_void() +\n  theme(legend.position = \"right\",  # Place legend at the right\n        legend.direction = \"vertical\",  # Arrange legend items vertically\n        legend.title = element_text(size = 12),  # Customize legend title size\n        legend.key.width = unit(2, \"cm\"),\n        legend.box = \"vertical\")  # Place legend title on top\n```\n\n```{r Black Pathways, fig.cap=\"Neighborhoods Following Pathway to Black Majority\", echo=FALSE, warning=FALSE, message=FALSE}\n# Create the map for Increasing Black, zoomed in on the five boroughs\nggplot(tract_increasing_black) +\n  geom_sf(aes(fill = factor(sequence_cluster)), color = NA) +  # Map sequence clusters\n  geom_sf(data = nyc_counties, fill = NA, color = \"black\", size = 0.5) +  # Add white county borders\n  scale_fill_manual(values = c(\"#FB8072\", \"#80B1D3\"),  # Custom color palette for Black clusters\n                    labels = c(\"Hispanic Majority to Black & Hispanic\", \n                               \"Black and Hispanic to Black Majority\"), \n                    name = \"Increasing Black Pathway\") +\n  coord_sf(xlim = c(-74.3, -73.7), ylim = c(40.5, 40.9), expand = FALSE) +  # Zoom into the NYC area\n  theme_void() +\n  theme(legend.position = \"right\",  # Place legend at the right\n        legend.direction = \"vertical\",  # Arrange legend items vertically\n        legend.title = element_text(size = 12),  # Customize legend title size\n        legend.key.width = unit(2, \"cm\"),\n        legend.box = \"vertical\")  # Place legend title on top\n\n```\n\nFinally, of the sequences depicting no change from 1980 to 2020, shown\nin Cluster 2, the majority of those are for tracts with a racial\nmajority: White, Hispanic, and Black. But those are followed by two\nstable sequences of neighborhoods with some racial diversity. The first\nis the majority White, but with a mixture of other races and the second\nis the mixed Black and Hispanic cluster. There is some debate in the\nliterature whether racially mixed neighborhoods can be stable over time,\nor are they simply depicting a point along a pathway of change when one\ngroup will eventually become a majority. Research has shown that highly\ndiverse neighborhoods are quite unstable over time, likely to transition\nto a less diverse state. In particular the transition from predominantly\nWhite towards majority Hispanic, results in a period of unstable racial\nmixture while that transition takes place [@wright2020instability].\nOthers have identified a small, but persistent set of racially diverse\nneighborhoods throughout the United States, but particularly in racially\ndiverse metropolitan areas [@hipp2023persistent]. Here, we find some\nevidence of stable, non-racially homogeneous Census Tracts.\n\n## Conclusions {#sec-conclusion}\n\nThis analysis showcases a method for developing and visualizing a\ntypology of neighborhood change pathways. We used a case study of\ndecennial racial and ethnic changes in New York City census tracts from\n1980-2020. The workflow first involves developing a cross-sectional\ntypology of classes describing the racial mixture of neighborhoods. To\ndo so, we used an unsupervised classification approach, *k*-means to\nderive six such clusters.\n\nWe demonstrated how determining the number of clusters often falls to\nmore of an art than a precise science as our final clustering for this\nanalysis exceeded the mathematically optimal three clusters, but\nprovided us with more nuance on the racial mixture of neighborhoods. We\nperformed the cluster analysis on all census tracts in the city for each\nof the five decennial census time stamps at once to ensure a temporally\nconsistent set of groupings. We then created sequences of neighborhood\nclusters over the study period and developed a typology of sequences\nthat grouped them based on the similarity of how they changed over time.\nTo do so, we used the OMtrans algorithm for computing sequence\ndissimilarity to ensure that the \\*ordering or sequencing of events was\npreserved. Finally, we mapped sequence clusters to spatially visualize\nneighborhoods that followed similar pathways of change. For our case\nstudy of the largest city in the United States, and one of the most\ndiverse, we observed a decline in the number of majority White census\ntracts over time. We identified several pathways of change leading to\nmajority Hispanic neighborhoods - emerging either out of previously\nmajority White or Black neighborhoods. We also observed pathways leading\nto majority Asian tracts, transitioning from Black and Hispanic\nneighborhoods, largely in Queens. A smaller share of neighborhoods\nbecame either increasingly White or Black. Neighborhoods that saw an\nincrease in the share of Whites, saw a notable increase in the\ntransition from Black and Hispanic to White and mixed race over the past\ntwo decades. Neighborhoods that increased in the share of Blacks largely\ntransitioned from Black and Hispanic to majority Black or from White and\nmixed race to Black and Hispanic. The benefits of the sequence analysis\ntechnique is in the clarity of the visuals for revealing common pathways\nof change. One of its drawbacks is that it requires segmenting\ncontinuous, longitudinal data into discrete, categorical groups. Other\nmethods for clustering time series offer an alternative approach for\nvisualizing trajectories over time.\n","srcMarkdownNoYaml":"\n\n## Introduction {#sec-intro}\n\nTracking and understanding neighborhood changes has been a central topic\nof urban studies and a fundamental concern for planning practitioners\n[@Galster2001; @Landis2016; @ChappleZuk2016]. Neighborhood change can be\ncomprehended according to various dimensions, from housing stock or\nbuilt environment changes to residents' demographic and socioeconomic\ncomposition [@Delmelle2022]. Thus, the study of neighborhood change\ninvolves analyzing multiple attribute dimensions through time for\nspatially situated units. Recent scholarship has progressed in the\nanalytical strategies used to study neighborhood trajectories,\nintroducing new methods for visualizing and mapping longitudinal\npathways of change for multiple dimensions [@Delmelle2022].\n\nIn this article, we demonstrate one such technique, sequence analysis,\nto explore decennial neighborhood racial and ethnic changes in New York\nCity from 1980-2020. The United States' demographic profile has become\nincreasingly diverse in the past several decades, driven by immigration\nand growing natural birth rates of the non-White population\n[@frey2022new]. Analyses following the release of the 2010 decennial\ncensus showed that increasing national diversity resulted in differing\nneighborhood trajectories, largely contingent on the broader\nmetropolitan context [@Terbeck2023; @Wright2014].\n\nMuch of the empirical scholarship on neighborhood racial and ethnic\nchanges has developed indices to categorize the makeup or diversity of\nracial and ethnic groups and then explored changes in a neighborhood's\ndiversity categorization over time. For example, a neighborhood might\ntransition from 'low diverse' to 'moderately diverse' from one decade to\nthe next [@farrell2011racial; @Wright2014]. Alternately, another set of\ntechniques aims to describe the longitudinal sequences or trajectories\nthat the racial and ethnic groups in a neighborhood have followed. Two\nmethods have been used for this purpose: statistical curve fitting and\nsequence analysis. With curve-fitting models like growth mixture models\nor latent growth models, mathematical functions fit each racial and\nethnic group under study that summarize the predominant trends\n[@Zwiers2018; @HippKim2023]. With sequence analysis, neighborhoods are\nfirst grouped into similar clusters according to their racial and ethnic\nmakeup using an unsupervised clustering algorithm like k-means. This is\ndone for all neighborhoods and all time stamps. Then, each neighborhood\nis assigned a categorical cluster over time, and finally, the sequences\nof these clusters are grouped using a sequence alignment technique\n[@Delmelle2016; @GonzalezLeonardo2023]. Both methods aim to develop a\ntypology of the predominant longitudinal pathways of change for multiple\nvariables at once.\n\nIn this article, we explore trajectories of neighborhood racial and\nethnic changes in the largest and one of the most diverse cities in the\nUnited States, New York City, using longitudinal census data up to the\nlatest 2020 decennial release. This notebook showcases a workflow that\nintroduces sequence analysis to the study of multidimensional\nneighborhood changes. We begin by processing the raw longitudinal census\ndata, then performing a k-means classification, and finally classify and\nmap sequences clusters. Our case study illustrates the gradual\nprogression that neighborhoods follow in when undergoing racial and\nethnic transformations. We observe an overall decline in the share of\nneighborhoods categorized by a large White majority population, in\nexchange for increasing diversity, especially Hispanic and Asian\npopulations.\n\n## Computational environment {#sec-compEnv}\n\nThe main libraries used in this paper include `dplyr` for processing\ntabular census data, `sf` for mapping the resulting clusters, `cluster`\nfor performing the `k-means` cluster analysis. Finally, to perform the\nsequence analysis, we use `TraMineR` [@gabadinho2011analyzing]. This is\na popular and continually updated R package for performing sequence\nanalysis for a host of social science applications, including analyses\nof neighborhood change [@Delmelle2016; @delmelle2017differentiating;\n@patias2020scalable].\n\n```{r loadlibraries, include = FALSE, warning=FALSE}\n# Set CRAN mirror\noptions(repos = c(CRAN = \"https://cloud.r-project.org/\"))\n\n# For data management\nif (!require('knitr')) install.packages('knitr'); library('knitr')\nif (!require('rmarkdown')) install.packages('rmarkdown'); library('rmarkdown')\nif (!require('dplyr')) install.packages('dplyr'); library('dplyr')\n\n#for reading in data\nif (!require('here')) install.packages('here'); library('here')\n\n#for reading in census data\nif (!require('tidycensus')) install.packages('tidycensus'); library('tidycensus')\nif (!require('tigris')) install.packages('tigris'); library('tigris')\noptions(tigris_class = \"sf\") # returns data in sf format\n\n#for data table formatting\nif (!require('knitr')) install.packages('knitr'); library('knitr')\n\n#for data table pivoting\nif (!require('tidyverse')) install.packages('tidyverse'); library('tidyverse')\n\n\n#mapping packages\nif (!require('sp')) install.packages('sp'); library('sp')\nif (!require('sf')) install.packages('sf'); library('sf')\n\n#For data visualization\nif (!require('ggplot2')) install.packages('ggplot2'); library('ggplot2')\n\n#for facet plots\nif (!require('gridExtra')) install.packages('gridExtra'); library('gridExtra')\n\n#For sequence clustering\nif (!require('TraMineR')) install.packages('TraMineR'); library('TraMineR')\n\n# For k-means and hierarchical cluster analysis\nif (!require('cluster')) install.packages('cluster'); library('cluster')\n\n#For visualizing k-means outputs\nif (!require('factoextra')) install.packages('factoextra'); library('factoextra')\n\n# For creating heat map to describe k-means cluster results\nif (!require('pheatmap')) install.packages('pheatmap'); library('pheatmap')\n\n# For creating heat map to describe k-means cluster results\nif (!require('RColorBrewer')) install.packages('RColorBrewer'); library('RColorBrewer')\n\n# Other packages (cowplot:inset maps; extrafont for additional sans serif fonts)\nif (!require('cowplot')) install.packages('cowplot'); library('cowplot')\nif (!require('patchwork')) install.packages('patchwork'); library('patchwork')\nif (!require('extrafont')) install.packages('extrafont'); library('extrafont')\nloadfonts(device = \"win\") \nif (!require('ggspatial')) install.packages('ggspatial'); library('ggspatial')\nloadfonts(device = \"win\") \n```\n\n## Data {#sec-data}\n\nWe use decennial census tract data to examine neighborhood racial and\nethnic changes. Census tracts serve as imperfect, yet well-used\nneighborhood proxies. Census tract boundaries change over time, further\ncomplicating the study of population dynamics within these boundaries.\nThere are several sources of data that have been harmonized using\ninterpolation techniques to a consistent set of boundaries over time. We\nuse the Longitudinal Tract Database (LTDB) which uses areal and\npopulation interpolation techniques alongside ancillary data on water\ncover to derive estimates [@logan2014interpolating]. Analyses of the\nerrors produced by three popular longitudinal data providers suggest\nthat LTDB performs similarly to the dataset produced by the National\nHistoric Geographic Information System (NHGIS) and both perform better\nthan the Neighborhood Change Database which relies solely on areal\ninterpolation without the inclusion of ancillary data\n[@logan2014interpolating]. Therefore, for this type of analysis either\nthe LTDB or NHGIS would be suitable dataset for this analysis.\n\nWe obtained the full count decennial data from LTDB from 1980-2020 from\nthe [Diversity and Disparties project at Brown\nUniversity](https://s4.ad.brown.edu/projects/diversity/Researcher/LTBDDload/DataList.aspx).\nThe census variables have been interpolated to 2010 tract boundaries.\nBecause the coding of census race and ethnicity changes over time, we\nopted to begin in 1980 as 1970, the earliest dataset available, did not\nrecord a count of Latino or Hispanic residents. The raw data contains\nall census tracts throughout the United States. For visualization\npurposes, we also import a shapefile of 2010 census tract boundaries\nusing the `tidycensus` package and setting the geometry to `true`.\n\n```{r importdata, warning=FALSE, cache = TRUE, message=FALSE}\nsetwd(here())  #current working directory\n\n#csv tables for longitudinal data\ncensus20<- read.csv(\"data/ltdb_std_2020_fullcount.csv\")\ncensus10<- read.csv(\"data/LTDB_Std_2010_fullcount.csv\")\ncensus00<- read.csv(\"data/LTDB_Std_2000_fullcount.csv\")\ncensus90<- read.csv(\"data/LTDB_Std_1990_fullcount.csv\")\ncensus80<- read.csv(\"data/LTDB_Std_1980_fullcount.csv\")\n\n#geometry data\n#filter for NYC counties (5 boroughs)\nnyc_counties <- c(\"Kings\", \"Queens\", \"New York\", \"Richmond\", \"Bronx\")\ntract <- get_decennial(geography = \"tract\",\n                       variables = \"P001001\",\n                       year = 2010,\n                       state = \"NY\",\n                       county = nyc_counties,\n                       geometry = TRUE,\n                       progress = FALSE)\n```\n\nWe next calculate the share of `White`, `Black`, `Hispanic`, and `Asian`\nresidents in each tract for each decade from the raw count using the\ntotal population as the denominator. We filter out tracts where the\npopulation is `0` and select only the relevant columns to create our\ndata frame. We then join all columns from the five decennial data frames\ninto one data frame called `census_all` and finally select only census\ntracts from the five counties that comprise New York City's five\nboroughs: Bronx County, Kings County (Brooklyn), New York County\n(Manhattan), Queens County, Richmond County (Staten Island).\n\n```{r calculatepercents, warning=FALSE, message=FALSE}\ncensus80 <- census80 %>% filter (POP80 >0)\ncensus80$perwhite80 <- census80$NHWHT80/census80$POP80\ncensus80$perblack80 <- census80$NHBLK80/census80$POP80\ncensus80$perhisp80 <- census80$HISP80/census80$POP80\ncensus80$perasian80 <- census80$ASIAN80/census80$POP80\ncensus80<- census80 %>% select(c(\"TRTID10\",\"perwhite80\", \"perblack80\", \"perhisp80\", \"perasian80\"))\n\ncensus90 <- census90 %>% filter (POP90 >0)\ncensus90$perwhite90 <- census90$NHWHT90/census90$POP90\ncensus90$perblack90 <- census90$NHBLK90/census90$POP90\ncensus90$perhisp90 <- census90$HISP90/census90$POP90\ncensus90$perasian90 <- census90$ASIAN90/census90$POP90\ncensus90<- census90 %>% select(c(\"TRTID10\",\"state\",\"county\",\"perwhite90\", \"perblack90\", \"perhisp90\", \"perasian90\"))\n\ncensus00 <- census00 %>% filter (POP00 >0)\ncensus00$perwhite00 <- census00$NHWHT00/census00$POP00\ncensus00$perblack00 <- census00$NHBLK00/census00$POP00\ncensus00$perhisp00 <- census00$HISP00/census00$POP00\ncensus00$perasian00 <- census00$ASIAN00/census00$POP00\ncensus00<- census00 %>% select(c(\"TRTID10\",\"perwhite00\", \"perblack00\", \"perhisp00\", \"perasian00\"))\n\ncensus10 <- census10 %>% rename(\"TRTID10\" = \"tractid\")\ncensus10$perwhite10 <- census10$nhwht10/census10$pop10\ncensus10$perblack10 <- census10$nhblk10/census10$pop10\ncensus10$perhisp10 <- census10$hisp10/census10$pop10\ncensus10$perasian10 <- census10$asian10/census10$pop10\ncensus10<- census10 %>% select(c(\"TRTID10\",\"perwhite10\", \"perblack10\", \"perhisp10\", \"perasian10\"))\n\ncensus20 <- census20 %>% rename(\"TRTID10\" = \"TRTID2010\")\ncensus20$perwhite20 <- census20$nhwt20/census20$pop20\ncensus20$perblack20 <- census20$nhblk20/census20$pop20\ncensus20$perhisp20 <- census20$hisp20/census20$pop20\ncensus20$perasian20 <- census20$asian20/census20$pop20\ncensus20<- census20 %>% select(c(\"TRTID10\",\"perwhite20\", \"perblack20\", \"perhisp20\", \"perasian20\"))\n\n#join all data frames from each decade\ncensus_all<- census90 %>% left_join(census00) %>% left_join(., census10) %>% left_join(., census20)%>% left_join(., census80)\n\n#Select NYC Counties. These include Bronx County, Kings County (Brooklyn), New York County (Manhattan), Queens County, Richmond County (Staten Island)\n\ncensus_select <- census_all %>% filter((state == \"NY\" & county == \"Bronx County\")|\n                              (state == \"NY\" & county == \"Kings County\")|\n                              (state == \"NY\" & county == \"New York County\")|\n                              (state == \"NY\" & county == \"Queens County\")|\n                              (state == \"NY\" & county == \"Richmond County\"))\n\n##remove NA values and state and county columns\ncensus_nyc <- na.omit(census_select)%>% select(-state, -county)\n\n#Select only the tractID column from the shapefile. Rename the field for ease of joining and convert to double to match the csv data.\ntract<- tract %>% select(\"GEOID\")\ntract<- rename(tract, TRTID10 = GEOID)\ntract$TRTID10<- as.double(tract$TRTID10)\n```\n\n```{r extract county boundaries, warning=FALSE, cache = TRUE, message=FALSE}\n# Set tigris options to return the data in sf format (spatial data frame)\noptions(tigris_class = \"sf\")\n\n# Download county boundaries for New York state\nny_counties <- counties(state = \"NY\", cb = TRUE,\n                         progress = FALSE)\n\n# Filter for only the New York City counties\nnyc_counties <- ny_counties %>%\n  filter(NAME %in% c(\"Bronx\", \"Kings\", \"New York\", \"Queens\", \"Richmond\"))\n\n# View the structure of the data\nprint(nyc_counties)\n```\n\n## Basic conceptual intuition {#sec-intuition}\n\nOur analysis features two fundamental steps. The first is the *k*-means\nclustering of the census tracts to derive multidimensional classes of\nneighborhoods containing similar racial and ethnic compositions.\n[@reibel2011neighborhood] introduced the idea of using an unsupervised\nclassification approach for studying neighborhood racial change as an\nalternative to the use of neighborhood diversity indices. The objective\nof the *k*-means algorithm is to group observations in such a way that\nmaximizes the similarity of observations within groups or clusters while\nmaximizing the dissimilarity between each cluster. In other words, the\ngoal is to group neighborhoods so that those most similar to each other\naccording to their racial and ethnic makeup are assigned to the same\ncluster and the clusters themselves are distinct from one another in\nterms of their makeup. With the *k*-means algorithm, the number of\nclusters, *k* must be determined *a priori*. To make this determination,\nit is customary to evaluate multiple solutions using various fit\nstatistics in conjunction with domain and geographic knowledge of the\ndata [@delmelle2015five]. It is also commonly recommended that input\nvariables first be normalized to avoid placing unequal emphasis on\nvariables that may be on different measurement scales. However, in our\ncase study, all of the racial and ethnic variables represent percentages\nof the population and so this step is not performed in the case study.\n\nOur ultimate goal is to understand the major pathways of neighborhood\nchange and so each neighborhood will be classified five times for 1980,\n1990, 2000, 2010, and 2020 to establish its longitudinal sequence. To\nensure that the clusters are temporally stable, we will perform the\nclustering for all years at once. New neighborhood typologies may emerge\nover time with this approach. In that instance, only tracts from the\nlater years would be assigned to the new cluster.\n\nLike *k*-means, sequence analysis is an unsupervised classification\ntechnique that aims to cluster similar longitudinal sequences. To\ndetermine the similarity of the sequences, a key step in this analysis\nis to create the dissimilarity measure. There are various approaches\nthat can be used to determine the similarity of categorical sequences.\n[@studer2016matters] provides a comprehensive overview of various\ntechniques for determining sequences dissimilarity for social science\napplications. In this case study, we are most interested in the\n*ordering* or *sequencing* of neighborhood cross-sectional racial\ngroups. Each neighborhood will have the same number of states, captured\nat the same decennial interval, which differs from studies of\nindividuals progressing through a series of life course events, for\nexample. In those cases, other considerations like the duration of time\nspent in each state or the timing of certain events may matter more in\nultimately grouping the sequences based on similarity. Here we aim to\ncreate clusters of sequences that follow a similar ordering of events -\nprogressing from example, a Majority White neighborhood through a Mixed\nRace state towards a Majority Hispanic state. The amount of time spent\nin each of these states might differ, but ultimately this describes\n*how* a neighborhood has changed over time. Given this, we follow\n[@delmelle2017differentiating] and use a variation on the popular\nOptimal Matching (OM) algorithm called OMstrans. The OM algorithm is a\nstring editing technique that determines the cost it would take to\ncompletely transform one sequence into another. This is achieved by\neither inserting, deleting, or substituting elements in one sequence\nuntil it matches another. For example, one neighborhood may have a\nsequence of *White*, *White*, *Mixed Race*, *Hispanic* while another\nneighborhood might follow the sequence *White*, *White*, *Mixed Race*,\n*Mixed Race*. Between these two strings, there is one entry that\ndiffers: the final state. To transform one to another, we could\nsubstitute *Hispanic* for *Mixed Race* in the second sequence, and the\ndissimilarity of the two sequences would be equal to the cost of that\nsubstitution. In the OMstrans variant, distances between sequences of\ntransitions are computed. This means that each state is merged with its\nprevious state to create a subsequence. In the previous illustrative\nexample, the first sequence becomes (*White-White*, *White-MixedRace*,\n*MixedRace-Hispanic*) and the OM cost evaluation is then applied to\nthese subsequences. This helps to ensure that the ordering of events is\npreserved in the sequence clusters. The importance given to the\npreservation of ordering is governed by the parameter *w*, the\norigin-transition parameter. When *w* = 1, OMstrans approximates the\ntraditional OM algorithm. A lower value places greater emphasis on the\nordering or sequencing of events.\n\n## Application {#sec-application}\n\n### Study Area\n\nOur study area consists of census tracts within the five Boroughs of New\nYork (see Figure below for an overview map).\n\n```{r visualize-area, warning=FALSE, cache=TRUE, message=FALSE, fig.cap=\"Overview map of New York City's five boroughs and surrounding counties\", fig.width=10, fig.height=8}\n\n# Filter for only the New York City counties\nnyc_counties <- ny_counties %>%\n  filter(NAME %in% c(\"Bronx\", \"Kings\", \"New York\", \"Queens\", \"Richmond\")) \n\n# Modify labels for specific counties\nnyc_counties$label_main <- ifelse(nyc_counties$NAME == \"New York\", \"New York\", \n                                  ifelse(nyc_counties$NAME == \"Kings\", \"Kings\",\n                                         ifelse(nyc_counties$NAME == \"Richmond\", \"Richmond\", \n                                                nyc_counties$NAME)))\n\nnyc_counties$label_paren <- ifelse(nyc_counties$NAME == \"New York\", \"(Manhattan)\", \n                                   ifelse(nyc_counties$NAME == \"Kings\", \"(Brooklyn)\",\n                                          ifelse(nyc_counties$NAME == \"Richmond\", \"(Staten Island)\", \n                                                 \"\")))\n\n# Calculate centroids for each county to get coordinates for labels\ncentroids <- st_centroid(nyc_counties)\ncoords <- st_coordinates(centroids)\n\n# Add the coordinates to the nyc_counties data frame\nnyc_counties <- nyc_counties %>%\n  mutate(X = coords[, 1],\n         Y = coords[, 2])\n\n# Adjust coordinates manually for specific counties\nnyc_counties <- nyc_counties %>% \n  mutate(\n    X = ifelse(NAME == \"New York\", X - 0.11, \n               ifelse(NAME == \"Richmond\", X + 0.012, X)), # Move \"New York\" left, Richmond right\n    Y = ifelse(NAME == \"New York\", Y + 0.005, \n               ifelse(NAME == \"Richmond\", Y + 0.03, Y)) # Adjust Richmond label higher\n  )\n\n#you can mask water area if you would like.\n#nyc_counties <- nyc_counties %>%  erase_water(area_threshold = 0.9)\n\n# Create the large map for the state without a scale bar\nzoomed_map <- ggplot() +\n  geom_sf(data = ny_counties, fill = \"gray85\", color = \"white\", size = 1) + # New York State outline\n  geom_sf(data = nyc_counties, fill = \"#85B0A9\", color = \"white\", size = 3) + # NYC counties in teal\n  geom_segment(aes(x = -73.98, y = 40.775, xend = -74.03, yend = 40.775), \n               color = \"gray25\", size = 0.5) + # Line from New York label to the boundary\n  geom_text(data = nyc_counties, aes(x = X, y = Y, label = label_main), \n            color = \"black\", size = 4, family = \"Arial\", fontface = \"bold\") + # Add main county names\n  geom_text(data = nyc_counties, aes(x = X, y = Y - 0.02, label = label_paren), \n            color = \"gray25\", size = 3.75, family = \"Arial\") + # Add parentheses labels in lighter color\n  geom_text(aes(x = -73.6, y = 40.725, label = \"Nassau\"), \n            color = \"gray55\", size = 4, family = \"Arial\", fontface = \"bold\") + # Corrected Nassau label position\n  geom_text(aes(x = -73.8, y = 40.98, label = \"Westchester\"), \n            color = \"gray55\", size = 4, family = \"Arial\", fontface = \"bold\") + # Corrected Westchester label\n  geom_text(aes(x = -73.6, y = 40.705, label = \"(Long Island)\"), \n            color = \"gray70\", size = 3.5, family = \"Arial\", fontface = \"bold\") + # Add Long Island label below Nassau\n  coord_sf(xlim = c(-74.25, -73.5), ylim = c(40.4, 41.05), expand = FALSE) + # Crop to focus on NYC\n  theme_minimal() +\n  theme(\n    panel.grid.major = element_blank(), # Remove major grid lines\n    panel.grid.minor = element_blank(), # Remove minor grid lines\n    axis.title = element_blank(), # Remove axis titles\n    axis.text = element_blank(), # Remove axis text (labels)\n    legend.position = \"none\", # Remove the legend\n    plot.margin = margin(0, 0, 0, 0) # Remove margins for a tighter crop\n  )\n\n# Create the large map for NY and surrounding counties with text annotation\ninset_map <- ggplot() +\n  geom_sf(data = ny_counties, fill = \"gray90\", color = NA, size = 1) + # All counties in gray, including Nassau and Westchester\n  geom_sf(data = nyc_counties, fill = \"#569289\", color = \"#569289\", size = 5) + # NYC counties in darker teal\n  annotate(\"text\", x = -76.2, y = 42.8, label = \"New York State\", \n           size = 5.25, color = \"gray49\", angle = 0, \n           alpha = 0.7, family = \"Arial\") + # Add text label\n  theme_minimal() +\n  theme(\n    panel.grid.major = element_blank(), # Remove major grid lines\n    panel.grid.minor = element_blank(), # Remove minor grid lines\n    plot.title = element_text(hjust = 0), # Align title to the left\n    plot.subtitle = element_text(hjust = 0), # Align subtitle to the left\n    axis.title = element_blank(), # Remove axis titles\n    axis.text = element_blank(), # Remove axis text (labels)\n    plot.margin = margin(0, 0, 0, 0) # Tighten margins\n  )\n\n# Combine the maps, placing the inset map within the zoomed-in map\nfinal_plot <- ggdraw() +\n  draw_plot(zoomed_map) +\n  draw_plot(inset_map, x = 0.07, y = 0.65, width = 0.3, height = 0.3) # Adjust position and size of the inset\n\n# Display the combined plot\nprint(final_plot)\n```\n\nTo begin our case study, we start by preparing the data for the\n*k*-means clustering. This involves pivoting the data frame so that each\ncensus tract is represented with five distinct rows, once for each\ndecennial value. To do so, we pivot from a wide to a long format and\nselect out just the four race and ethnicity values to be used in the\nclustering.\n\n```{r kmeans, warning=FALSE, cache=TRUE, message=FALSE}\n# Convert the data frame from wide to long format\ncensus_long <- census_nyc %>%\n  pivot_longer(cols = starts_with(\"per\"), \n               names_to = c(\".value\", \"year\"), \n               names_pattern = \"per(\\\\w+)(\\\\d{2})\") %>%\n  mutate(year = case_when(\n    year == \"80\" ~ 1980,\n    year == \"90\" ~ 1990,\n    year == \"00\" ~ 2000,\n    year == \"10\" ~ 2010,\n    year == \"20\" ~ 2020,\n    TRUE ~ as.integer(year)\n  ))\n\n\ndata_for_clustering <- census_long %>%\n  select(white, black, hisp, asian)\n```\n\nAs explained above, the *k*-means clustering procedure requires that the\nnumber of clusters, *k* be specified *a priori*. There are fit\nstatistics that attempt to determine the optimal number of clusters,\nconsidering the similarity of observations within each cluster and the\ndistinctiveness of the clusters from each other. However, these\nmathematically-derived solutions are devoid of any contextual or\ntheoretical understanding of the problem under study. Therefore, the\nselection of *k* often becomes more akin to art than a science\n[@von2012clustering], considering the objective of the study. We begin\nwith two common data-driven approaches that explore multiple clustering\nsolutions for different *k* values and then examines the *within sum of\nsquares* (WSS) and the *average silhouette score* for each solution. The\nWSS assesses how compact a clustering solution is, or how homogeneous\nthe observations assigned to each cluster are, and the average\nsilhouette score measures how well separated each cluster is from each\nother. Our objective is to derive a typology of neighborhoods according\nto their racial and ethnic makeup, for four groups: percent White,\nBlack, Hispanic, and Asian. The Figure below shows the results of the\nclustering analysis; the Elbow method plot suggests the optimal number\nof clusters, while the Silhouette method plot helps validate the cluster\nseparation.\n\n```{r kmeans1, warning=FALSE, cache=TRUE, message=FALSE}\n# Now do the k-means clustering on all\n\ndata_for_clustering <- census_long %>%\n  select(white, black, hisp, asian)\n\n# Function to calculate total within-cluster sum of squares for different k\nwss <- function(k) {\n  kmeans(data_for_clustering, k, nstart = 10)$tot.withinss\n}\n\n# Compute and plot wss for k = 1 to k = 10\nk.values <- 1:10\nwss_values <- map_dbl(k.values, wss)\n\n# Elbow method plot\nplot(k.values, wss_values, type = \"b\", pch = 19, frame = FALSE,\n     xlab = \"Number of clusters K\",\n     ylab = \"Total within-clusters sum of squares\")\n\n# Silhouette method for determining the optimal number of clusters\nfviz_nbclust(data_for_clustering, kmeans, method = \"silhouette\")\n```\n\n### Exploring *k*-means Cluster Solutions\n\nAccording to these plots, the mathematically optimal number of\nneighborhood clusters for racial makeup is three. We can further explore\nthe makeup of neighborhoods within these three clusters a few ways to\ndetermine if, in fact, three clusters provides a meaningful segmentation\nof four distinct racial and ethnic groups. In the plots below, we can\nvisualize the average silhouette value for each cluster. The\n*Silhouette* values range from -1 to 1; values close to 1 suggest that\nthe observations are well clustered while negative values suggest that\nan observation might be assigned to the wrong cluster. From the plot,\nClusters 2 and 3 appears to be the most cohesive clusters, with average\nsilhouette widths of 0.64, while cluster 1 has some potentially poorly\nclassified neighborhoods. Descriptions of the racial and ethnic makeup\nof the clusters are obtained from the associated stacked bar charts. We\ncan see that Cluster 1 is characterized as being nearly 50 percent\nHispanic, with near equal shares of Whites, Blacks, and Asians. Cluster\n2 is majority Black with approximately 15 percent Hispanics and few\nWhites and Asians. Finally, Cluster 3 is majority White. Therefore, this\nsegmentation provides us with clusters indicating the dominant racial\ngroups, but may miss some nuances of other racial and ethnic\nneighborhood compositions. We can therefore explore how increasing *k*\nmay portray a richer portrait of neighborhood demographic profiles. The\nFigure below illustrates the Silhouette Analysis to assess cluster\nseparation, and the demographic makeup of the three clusters (bottom\nFigure).\n\n```{r threeclusters, warning=FALSE, cache=TRUE, message=FALSE, fig.cap=\"Cluster Analysis Results: Silhouette Analysis and Cluster Demographic Makeup\"}\n# Assume the optimal number of clusters (k) is 3 from the previous steps\nset.seed(123)\nkmeans_result <- kmeans(data_for_clustering, centers = 3, nstart = 25)\n\n# Add the cluster assignments to the original data\ncensus_long$cluster <- kmeans_result$cluster\n\n# Silhouette Analysis\nsil <- silhouette(kmeans_result$cluster, dist(data_for_clustering))\nfviz_silhouette(sil)\n\n# Extract silhouette information to a data frame (df)\nsil_df <- as.data.frame(sil[, 1:3])\ncolnames(sil_df) <- c(\"Cluster\", \"Silhouette Width\", \"Neighboring Cluster\")\n\n# Cluster profiles\ncluster_profiles <- census_long %>%\n  group_by(cluster) %>%\n  summarise(across(c(white, black, hisp, asian), ~ round(mean(.), 2)))\n\n# Print the table as a formatted table\nkable(cluster_profiles, caption = \"Cluster Profiles: Average Demographics\", \n      col.names = c(\"Cluster\", \"White\", \"Black\", \"Hispanic\", \"Asian\"),\n      format = \"markdown\")\n\n# Reshape the data from wide to long format\ncluster_profiles_long <- cluster_profiles %>%\n  pivot_longer(cols = c(\"white\", \"black\", \"hisp\", \"asian\"), \n               names_to = \"Demographic\", values_to = \"Proportion\")\n\n# Create the stacked bar chart\nggplot(cluster_profiles_long, aes(x = factor(cluster), y = Proportion, fill = Demographic)) +\n  geom_bar(stat = \"identity\") +\n  labs(title = \"Cluster Demographic Makeup - 3 clusters\", x = \"Cluster\", y = \"Proportion\") +\n  scale_fill_brewer(palette = \"Set3\") +  # Adjust color palette if desired\n  theme_minimal()\n```\n\nNext, we compare 4, 5, and 6 cluster solutions. We can see that the\naverage silhouette of the solutions declines as the number of clusters\nincreases. The demographic profiles show several new neighborhood\ntypologies emerge with more clusters added. With a four cluster\nsolution, we observe neighborhood typologies for each of the three\ndominant racial and ethic groups: White, Hispanic, and Black along with\none mixed neighborhood type, shown in cluster 4. As expected, that\ncluster displays the lowest silhouette value, with some potentially\nmis-classified neighborhoods. The 5 cluster solution adds a cluster\nshowing a majority Asian population, alongside two majority White\npopulations - one showing more diversity than the other), and a majority\nBlack, and Hispanic group. Finally, a 6 cluster solution shows more\nracially mixed groups, but at the expense of less well-defined or\nseparated clusters. In the code below, each variable name ends with a\nnumber (4, 5 or 6), indicating which number of clusters (k) it\nrepresents. The results displays the silhouette analysis results for\nclustering into (a) four clusters, (b) five clusters, and (c) six\nclusters, illustrating the cohesion and separation of clusters at\ndifferent sizes.\n\n```{r silhouette-plots, warning=FALSE, cache=TRUE, message=FALSE,  fig.cap=\"Silhouette Analysis for Different Cluster Sizes: (top) Four Clusters, (middle) Five Clusters, and (bottom) Six Clusters.\"}\n# Perform k-means clustering for 4, 5, and 6 clusters\nset.seed(123)\nkmeans_4 <- kmeans(data_for_clustering, centers = 4, nstart = 25)\nkmeans_5 <- kmeans(data_for_clustering, centers = 5, nstart = 25)\nkmeans_6 <- kmeans(data_for_clustering, centers = 6, nstart = 25)\n\n# Add cluster assignment to original data\ncensus_long$cluster_4 <- kmeans_4$cluster\ncensus_long$cluster_5 <- kmeans_5$cluster\ncensus_long$cluster_6 <- kmeans_6$cluster\n\n# Silhouette analysis for 4, 5, and 6 clusters\nsil_4 <- silhouette(kmeans_4$cluster, dist(data_for_clustering))\nsil_5 <- silhouette(kmeans_5$cluster, dist(data_for_clustering))\nsil_6 <- silhouette(kmeans_6$cluster, dist(data_for_clustering))\n\n# Plot silhouette for 4 clusters\nplot_4 <- fviz_silhouette(sil_4) + ggtitle(\"Silhouette Plot - Four Clusters\")\n\n# Plot silhouette for 5 clusters\nplot_5 <- fviz_silhouette(sil_5) + ggtitle(\"Silhouette Plot - Five Clusters\")\n\n# Plot silhouette for 6 clusters\nplot_6 <- fviz_silhouette(sil_6) + ggtitle(\"Silhouette Plot - Six Clusters\")\n\n# Combine the three plots into a faceted view\ngrid.arrange(plot_4, plot_5, plot_6, ncol = 1)\n```\n\nThe figure illustrates the demographic composition of clusters for\ndifferent clustering solutions: (a) four clusters, (b) five clusters,\nand (c) six clusters, highlighting how demographic groups are\ndistributed across various cluster labels.\n\n```{r explore-demographics, warning=FALSE, cache=TRUE, message=FALSE, fig.cap=\"Geographic variation of Labeled Clusters for Different Clustering Solutions.\"}\n# We need to hard code the labels to be able to compare the demographic profile of each solution. This is because R randomly assigns the label each time, even if the clustering solution is the same because we set the seed.\nlabel_clusters <- function(cluster_profiles) {\n  cluster_profiles %>%\n    mutate(\n      label = case_when(\n        white > 0.75 ~ \"3 White\",\n        hisp > 0.45 ~ \"2 Hispanic\",\n        black > 0.75 ~ \"1 Black\",\n        asian > 0.45 ~ \"5 Asian\",\n        white < 0.56 & hisp > 0.20 & black < 0.20 ~ \"4 Mixed\",\n        black > 0.49 & hisp > 0.25 & white < 0.15 ~ \"6 Black and Hispanic\",\n        TRUE ~ \"Other\"  # Default label if none of the conditions are met\n      )\n    )\n}\n\n# Create cluster profiles and label them according to your custom rules\ncluster_profiles_4 <- census_long %>%\n  group_by(cluster_4) %>%\n  summarise(across(c(white, black, hisp, asian), ~ round(mean(.), 2))) %>%\n  mutate(`Clustering_Solution` = \"4 Clusters\", Cluster = cluster_4) %>%\n  label_clusters()\n\ncluster_profiles_5 <- census_long %>%\n  group_by(cluster_5) %>%\n  summarise(across(c(white, black, hisp, asian), ~ round(mean(.), 2))) %>%\n  mutate(`Clustering_Solution` = \"5 Clusters\", Cluster = cluster_5) %>%\n  label_clusters()\n\ncluster_profiles_6 <- census_long %>%\n  group_by(cluster_6) %>%\n  summarise(across(c(white, black, hisp, asian), ~ round(mean(.), 2))) %>%\n  mutate(`Clustering_Solution` = \"6 Clusters\", Cluster = cluster_6) %>%\n  label_clusters()\n\n# Combine all cluster profiles into one table\ncluster_profiles_combined <- bind_rows(cluster_profiles_4, cluster_profiles_5, cluster_profiles_6)\n\n# Map the labels back to the original tracts by joining based on cluster assignments\ncensus_long <- census_long %>%\n  left_join(cluster_profiles_4 %>% select(Cluster, label) %>% rename(label_4 = label), by = c(\"cluster_4\" = \"Cluster\")) %>%\n  left_join(cluster_profiles_5 %>% select(Cluster, label) %>% rename(label_5 = label), by = c(\"cluster_5\" = \"Cluster\")) %>%\n  left_join(cluster_profiles_6 %>% select(Cluster, label) %>% rename(label_6 = label), by = c(\"cluster_6\" = \"Cluster\"))\n\n# Reshape data for plotting\ncluster_profiles_long <- cluster_profiles_combined %>%\n  pivot_longer(cols = c(\"white\", \"black\", \"hisp\", \"asian\"),\n               names_to = \"Demographic\", values_to = \"Proportion\")\n\n# Plot stacked bar charts of demographic makeup for each labeled cluster\nggplot(cluster_profiles_long, aes(x = label, y = Proportion, fill = Demographic)) +\n  geom_bar(stat = \"identity\", position = \"stack\") +\n  facet_grid(Clustering_Solution ~ ., scales = \"free_x\") +  # Facet vertically by clustering solution\n  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +\n  labs(\n    title = \"\",\n    x = \"Cluster Label\",\n    y = \"Proportion of Demographic Group\",\n    fill = \"Demographic Group\"\n  ) +\n  theme_minimal() +\n  theme(\n    axis.text.x = element_text(angle = 45, hjust = 1),\n    plot.title = element_text(hjust = 0.5)\n  )\n```\n\nWe can explore how this plays out for a specific observation. For\nexample, take the first census tract in the data frame for the year\n`2020`. This tract's racial composition was `58%` Black and `30%`\nHispanic with small shares of Whites and Asians. With the four cluster\nsolution, this tract was classified into class 1, `Majority Black`. For\nthe five cluster solution, it was also classified as `Majority Black`,\nand for the six cluster solution, `Black and Hispanic`. In 1990, that\nsame tract was `34%` black and `61%` Hispanic, resulting in the tract\nbeing classified as `Majority Hispanic` by all three clustering\nsolutions. When looking at change over time, the neighborhood will\neither be registered as transitioning from `Majority Hispanic` to either\n`Majority Black` or `Black and Hispanic`, depending on the final cluster\nsolution. In this instance, the 6 cluster solution provides a more\naccurate portrayal of the dynamics - while the neighborhood did\ntechnically become majority Black, there is still a significant Hispanic\npresence, a detail that would have been omitted by limiting the number\nof groups.\n\nFinally, we can examine the spatial distribution of these clustering\nsolutions to help aid in the final determination for the sequence\nanalysis. Since we did the cluster analysis on all decades, for this\npurpose, we will contrast the 4, 5, and 6 cluster solutions just for\n2020. All three maps depict a similar spatial pattern, but with a more\nfragmented pattern in the case of the 6 cluster solution. For example,\nthe first two maps show contiguous tracts of the predominantly Black\ncluster, but the third map shows the emergence of the\n`Black and Hispanic` group largely forming on the outskirts of this\nspatial cluster. Another aparent distinction is the large spatial\ncluster of the `Asian` cluster in Queens, which had been labeled as\n`Mixed` in the 4 cluster solution.\n\nTo better understand details on racial neighborhood transitions, we will\ngo with the larger number of clusters, 6, despite the mathematical\npreference for a 3 cluster solution. Our result illustrates the\ndemographic distribution of labeled clusters for different clustering\nsolutions: four clusters, five clusters, and six clusters.\n\n```{r demographic-distribution, warning=FALSE, cache=TRUE, message=FALSE, fig.cap=\"Demographic Distribution of Labeled Clusters for Different Clustering Solutions: Four Clusters (top), Five Clusters (middle), and Six Clusters (bottom).\"}\n# Filter data for the year 2020 and merge labels with tract data for mapping\ntract_clusters_2020 <- tract %>% erase_water(area_threshold = 0.9) %>%\n  left_join(census_long %>%\n              filter(year == 2020) %>%  # Filter for the year 2020\n              select(TRTID10, cluster_4, cluster_5, cluster_6, label_4, label_5, label_6), by = \"TRTID10\") %>%\n  pivot_longer(cols = c(\"cluster_4\", \"cluster_5\", \"cluster_6\"),\n               names_to = \"ClusterSolution\", values_to = \"Cluster\") %>%\n  pivot_longer(cols = c(\"label_4\", \"label_5\", \"label_6\"),\n               names_to = \"LabelSolution\", values_to = \"Label\") %>%\n  filter(str_replace(ClusterSolution, \"cluster_\", \"\") == str_replace(LabelSolution, \"label_\", \"\")) %>%\n  mutate(Label = factor(Label)) %>%\n  mutate(ClusterSolution = recode(ClusterSolution,\n                                  \"cluster_4\" = \"4 Clusters\",\n                                  \"cluster_5\" = \"5 Clusters\",\n                                  \"cluster_6\" = \"6 Clusters\")) %>%\n  mutate(ClusterSolution = factor(ClusterSolution, levels = c(\"4 Clusters\", \"5 Clusters\", \"6 Clusters\")))\n\n# Create the base plot with the labeled clusters\nbase_plot <- ggplot(tract_clusters_2020) +\n  geom_sf(aes(fill = Label), color = NA) +  # Use the Label field for fill\n  geom_sf(data = nyc_counties, fill = NA, color = \"black\", size = 0.5) +  # Add county outlines\n  facet_wrap(~ ClusterSolution, nrow = 1) +  # Facet horizontally by clustering solution\n  scale_fill_manual(\n    values = c(\"3 White\" = \"#F0E442\", \"2 Hispanic\" = \"#D55E00\", \n               \"1 Black\" = \"#0072B2\", \"5 Asian\" = \"#CC79A7\", \n               \"4 Mixed\" = \"#009E73\", \"6 Black and Hispanic\" = \"#56B4E9\"),\n    labels = c(\"Black\", \"Hispanic\", \"White\", \"Asian\", \"Mixed\", \"Black and Hispanic\")  # Remove numbers from labels\n  ) +\n  labs(x = \"\", y = \"\", fill = NULL) +  # Remove the title and set fill to NULL to remove \"Label\"\n  theme_void() +\n  theme(\n    strip.text = element_text(hjust = .5, vjust = .1, face = \"italic\", size = 12),  # Center facet labels\n    legend.position = \"bottom\",  # Place the legend at the bottom\n    legend.title = element_blank(),  # Ensure legend title is blank\n    legend.text = element_text(size = 8)\n  ) +\n  guides(fill = guide_legend(nrow = 1, byrow = TRUE, label.position = \"bottom\"))  # Place category names under the boxes\n\n# Display the plot\ngrid.arrange(base_plot)\n```\n\nWe can begin with a simple exploration of the spatial changes over time\nin the maps showing the six clusters from 1980-2020 in a series of small\nmultiples. From these maps, we can pick out some general spatial\npatterns over time. For example, we can see the expanse of neighborhoods\nclassified as majority White from 1980 significantly diminishes by 2020.\nThe share of Hispanics is shown to increase over time in the northern\nsections of the City. Towards the East, we see neighborhoods generally\ntransition from predominantly White in 1980 to White and Mixed Race and\neventually to Asian by 2020. There are also some evident stable\nclusters. For instance, the two clusters of predominantly black\nneighborhoods in the South and Southeast appear quite table over time.\nHowever, the cluster of majority Black neighborhoods in towards the\nnorth of Manhattan is diminished, replaced by a Black and Hispanic\nclassification.\n\n```{r smallmultiples,warning=FALSE, cache=TRUE, message=FALSE, fig.show='hold', fig.cap=\"Change in the cluster memmbership over five decades\"}\ndecades <- c(1980, 1990, 2000, 2010, 2020)\n  \n# Filter and prepare data for mapping\ntract_clusters_decades <- tract %>%\n  left_join(census_long %>%\n              select(TRTID10, year, label_6), by = \"TRTID10\") %>%\n  filter(!is.na(label_6)) \n\n# Set factor levels for year to ensure proper ordering\ntract_clusters_decades <- tract_clusters_decades %>%\n  mutate(year = factor(year, levels = decades))\n\n# Plot faceted maps for each decade (year)\nggplot(tract_clusters_decades) +\n  geom_sf(aes(fill = label_6), color = NA) +  # Use factor to ensure proper color assignment\n  geom_sf(data = nyc_counties, fill = NA, color = \"black\", size = 0.5) +  # Add county outlines\n  facet_wrap(~ year, ncol = 5) +  # Facet by year with 5 columns\n  scale_fill_manual(\n    values = c(\"3 White\" = \"#F0E442\", \"2 Hispanic\" = \"#D55E00\", \"1 Black\" = \"#0072B2\",\n               \"5 Asian\" = \"#CC79A7\", \"4 Mixed\" = \"#009E73\", \"6 Black and Hispanic\" = \"#56B4E9\"),\n    labels = c(\"Black\", \"Hispanic\", \"White\", \"Asian\", \"Mixed\", \"Black and Hispanic\"),  # Remove numbers from labels\n    name = \"\"  # Remove legend title\n  ) +\n  labs(title = \" \", x = \"\", y = \"\") +\n  theme_void() +\n  theme(\n    plot.title = element_text(hjust = 0, color = \"gray\"),  # Set the title color to gray\n    legend.position = \"bottom\",  # Move legend to the bottom\n    legend.direction = \"horizontal\",  # Make the legend horizontal\n    legend.title = element_blank(),  # Ensure the legend title is blank\n    legend.key.size = unit(0.6, \"cm\"),  # Set consistent size for legend boxes\n    legend.key.height = unit(0.6, \"cm\"),  # Set consistent height for legend boxes\n    legend.key.width = unit(0.5, \"cm\")  # Set consistent width for legend boxes\n  ) +\n  guides(\n    fill = guide_legend(\n      nrow = 1, byrow = TRUE, label.position = \"bottom\"  # Place category names under the legend boxes\n    )\n  )\n```\n\n### Sequence Analysis\n\nOur objective with the sequence classification is to come up with a\ntypology of neighborhood sequences over time to describe general\npathways of change. Each neighborhood has a sequence of classes over\ntime, one of 6 categorical groups for each of the five decennial census\nvalues from 1980-2020. The first step in the analysis is to convert the\ndata frame into a sequence for each neighborhood. We can see an\nillustrative example of the longitudinal sequences from the first five\nrecords. Classes are separated by a dash (-). There are 2122 sequences\nin the dataset and 197 unique sequences; all sequences are displayed in\nthe plot below. Thus, the purpose of clustering the sequences is to\nextract the general patterns present from the set of all sequences.\n\n```{r createsequences, warning=FALSE, cache=TRUE, message=FALSE, fig.cap=\"Sequence of each neighborhood.\"}\n# Convert the data from long to wide format to have a sequence for each neighborhood\n# Assuming census_long is your data frame\ncensus_wide <- tract_clusters_decades %>%\n  st_drop_geometry() %>%\n  select(TRTID10, year, label_6) %>%\n  pivot_wider(names_from = year, values_from = label_6)\n\n# Rename the columns to show only the year (remove \"cluster_\" prefix if it was added during previous steps)\ncolnames(census_wide) <- sub(\"cluster_\", \"\", colnames(census_wide))\n\n# Ensure columns are in the correct order by year\ncensus_wide <- census_wide %>%\n  select(TRTID10, `1980`, `1990`, `2000`, `2010`, `2020`)\n\n# Ensure the sequence columns are factors\ncensus_wide <- census_wide %>%\n  mutate(across(starts_with(\"19\") | starts_with(\"20\"), as.factor))\n\n# Check the distinct states (categories) in your sequences\nunique_states <- unique(unlist(census_wide[, -1]))  # Exclude TRTID10 column\nnum_states <- length(unique_states)\nprint(unique_states)\nprint(num_states)  # Number of unique states\n\n# Define the custom color palette with the correct colors\ncustom_palette <- c(\n  \"1 Black\" = \"#0072B2\",\n  \"2 Hispanic\" = \"#D55E00\",\n  \"3 White\" = \"#F0E442\",\n  \"4 Mixed\" = \"#009E73\",\n  \"5 Asian\" = \"#CC79A7\",\n  \"6 Black and Hispanic\" = \"#56B4E9\"\n)\n\n\n# Create the sequence object with the renamed columns\nsequence_data <- seqdef(census_wide[, -1], cpal = custom_palette)  # Exclude the TRTID10 column\n\n# Check the number of distinct sequences\nnum_sequences <- seqtab(sequence_data, idx = 0) %>% nrow\nprint(num_sequences)\n\n# Display the first few sequences\nhead(sequence_data)\n\n# Plot the sequences\nseqIplot(sequence_data,                                             # Sequence object\n         with.legend = \"right\",                                # Display legend on right side of plot\n         cex.legend = 0.6,                                     # Change size of legend\n         main = \"Neighborhood Racial and Ethnic Trajectories\") # Plot title\n```\n\nThe next objective is to compute the dissimilarity between all\nsequences. As described previously, we use the OMstrans algorithm to\npreserve the ordering of events as we are most interested in describing\nhow neighborhoods have generally transitioned over time. We set a low\nvalue (`0.1`) for the parameter `otto` in the `seqdist` command which is\nthe origin-transition trade-off weight. This emphasizes the ordering of\nsequence states. We also set a high `indel` cost of `3`. Finally,\nsubstitution costs are a function of the transition rate `TRATE` between\nstates. This places a lower cost on more frequent transitions.\n\nOnce the cost matrix is established, we then cluster the sequences using\nthe dissimilarity matrix as an input to generate the typology. We follow\nan iterative process in determining the optimal solution like the one\ndescribed above for the *k* means clustering. In short, multiple\nsolutions are tested and the resulting sequence clusters are visualized\nto inspect for heterogeneity. Because our clustering and distance matrix\nare optimized for describing transitions over time, we end up with one\ncluster that contains all neighborhoods that remained constant over\ntime. These sequences are very different from one another in the\nneighborhood types they describe, but they all represent a pathway or\nsequences of no change.\n\nTo describe the resulting sequence clusters, we plot a Sequence\nFrequency Plot for each cluster. We settled on 14 trajectory clusters\ndescribing neighborhood racial and ethnic transitions from 1980 to 2020\nin New York City. The Sequence Frequency Plots illustrate the sequences\nbelonging to each cluster and the sequence bars are scaled to visualize\nthe frequency of each sequence. A summary of the trajectories is as\nfollows:\n\n1.  Hispanic Majority to Black and Hispanic\n2.  Stability Cluster\n3.  White and Mixed Race to Hispanic Majority\n4.  White to White and Mixed Race to Hispanic Majority\n5.  Black and Hispanic to Hispanic Majority\n6.  White Majority to White and Mixed Race\n7.  White and Mixed Race to Black and Hispanic\n8.  Black and Hispanic to Black Majority\n9.  White and Mixed Race to Asian Majority\n10. White and Mixed Race to White Majority\n11. Black and Hispanic to White and Mixed Race\n12. White and Mixed Race to Asian Majority\n13. Black Majority to Black and Hispanic\n14. Black and Hispanic to Asian Majority\n\n```{r clustersequences, warning=FALSE, cache=TRUE, message=FALSE}\n# Pass this palette to seqdef\n# Define sequence data with custom color palette\nsequence_data <- seqdef(census_wide[, -1], cpal = custom_palette)  # Exclude the TRTID10 column\n\n# Compute Optimal Matching (OM) distances using the TRATE cost method\ncosts <- seqcost(sequence_data, method = \"TRATE\")\nom_distances <- seqdist(sequence_data, method = \"OMstran\", indel = 3, sm = costs$sm, otto = 0.1)\n\n# Perform hierarchical clustering using Ward's method on the OM distances\nclusterward <- agnes(om_distances, diss = TRUE, method = \"ward\")\n\n# Define the number of clusters and assign clusters to the sequence data\nnum_clusters <- 14\nclusters <- cutree(clusterward, k = num_clusters)\ncensus_wide$sequence_cluster <- clusters\n\n# Define cluster names for reference\ncluster_names1 <- c(\n  \"1 Black & Hispanic to Hispanic Majority\", \n  \"2 Stability\", \n  \"3 White Mixed Race to Hispanic\", \n  \"4 White to Mixed Race to Hispanic Majority\", \n  \"5 Majority White to Increasing Diversity\"\n)\n\n# Plot sequences for clusters in groups, adjusting legend settings\nplot_sequence_clusters <- function(cluster_range) {\n  seqfplot(\n    sequence_data[census_wide$sequence_cluster %in% cluster_range, ], \n    group = census_wide$sequence_cluster[census_wide$sequence_cluster %in% cluster_range], \n    sortv = \"from.start\", \n    border = NA, \n    with.legend = \"right\",         # Place the legend on the right\n    legend.prop = 0.2,             # Set the proportion of the plot area for the legend\n    legend.border = FALSE          # Remove the border around the legend\n  )\n}\n\n# Plot sequences for specified cluster ranges\nplot_sequence_clusters(1:2)\nplot_sequence_clusters(3:4)\nplot_sequence_clusters(5:6)\nplot_sequence_clusters(7:8)\nplot_sequence_clusters(9:10)\nplot_sequence_clusters(11:12)\nplot_sequence_clusters(13:14)\n```\n\nOf these 14 pathways, there are 3 that lead to the formation of a\nneighborhood transitioning into a Hispanic Majority cluster by 2020.\nThis includes Cluster 3 - showing neighborhoods that went from being a\nslight majority White, but with a mixture of other races in 1980 and\n1990 to transitioning to majority Hispanic by 1990 or 2000. Some of\nthese sequences indicate a continued transition towards becoming\nmajority Asian in the later years. Further segmenting the sequences into\nmore clusters may have separated out those trajectories, but for the\nsake of brevity, we leave them mixed in. Spatially, these are shown in\norange on the map below and can be see clustered in Staten Island,\nQueens, and in the Northern portion of the city. They are also notably\nadjacent to neighborhoods indicated by the red color, those representing\nsequence cluster 4, transitioning from majority White to White and Mixed\nRace and then to Majority Hispanic. This latter cluster might represent\nthe precursor to cluster 3, but are neighborhoods that made this\ntransition from majority White later, where the changes took time to\nspatially spillover to adjacent neighborhoods, as indicated by the map.\nBoth of these pathways depict a transition from largely White\npopulations to largely Hispanic.\n\nThe third pathway depicting a transition to majority Hispanic is\ndistinct. It is represented by cluster 5 showing a transition from\neither majority Black neighborhoods towards a mixed Hispanic and Black\ngroup and eventually majority Hispanic or, beginning the 1980 time\nstamp, in a more mixed Black and Hispanic state. Geographically, these\nneighborhoods are shown more in the northern sections of Manhattan and\nthe Bronx.\n\nFrom these two sets of sequence clusters, we can see that majority\nHispanic neighborhoods in New York City have emerged out of either\nmajority Black or Majority White neighborhoods over time.\n\n```{r transition, fig.cap=\"Neighborhoods Following Pathway to Hispanic Majority with White County Borders.\", echo=FALSE, warning=FALSE, message=FALSE}\n# Define the Hispanic majority clusters for plotting\nhispanic_majority_clusters <- census_wide %>%\n  filter(sequence_cluster %in% c(4, 5, 6))  # Filter clusters 4, 5, and 6\n\n# Join the filtered data with the tract shapefile based on TRTID10\ntract_hispanic_majority <- tract %>%\n  left_join(hispanic_majority_clusters, by = \"TRTID10\") %>% erase_water(area_threshold = 0.75)\n\n# Add county borders and color to the plot\nggplot(tract_hispanic_majority) +\n  geom_sf(aes(fill = factor(sequence_cluster)), color = NA) +  # Map sequence clusters\n  geom_sf(data = nyc_counties, fill = NA, color = \"black\", size = 0.5) +  # Add white county borders\n  scale_fill_manual(values = c(\"#FB8072\", \"#80B1D3\", \"#FDB462\"),  # Custom color palette\n                    labels = c(\"3 White - White, Mixed Race - Hispanic\", \n                               \"5 Black - Black & Hispanic - Hispanic\", \n                               \"4 White, Mixed Race - Hispanic\"), \n                    name = \"Hispanic Majority Pathway\") +\n  labs(title = \"\", \n       x = \"\", y = \"\") +\n  theme_void() +\n  theme(legend.position = \"right\",  # Place legend on the right\n        legend.direction = \"vertical\",  # Arrange legend items vertically\n        legend.title = element_text(size = 12),  # Customize legend title size\n        legend.key.width = unit(2, \"cm\"),  # Adjust legend key width\n        legend.box = \"vertical\")  # Place legend title on top of the legend\n```\n\nThere are also 3 pathways leading to an Asian majority neighborhood\ntype. These include clusters 9 and 12 which are also likely\ncontinuations of longer trajectories, that show a gradual transition\nfrom Majority White to White mixed race and eventually to Asian\nMajority. Geographically, these are clustered in the northern section of\nQueens. Sequence cluster 14 is more distinct in that the Asian majority\ntransitioned from the Black and Hispanic mixed group and spatially, they\nare generally located in upper Manhattan and the Bronx.\n\n```{r AsianPathways, fig.cap=\"Neighborhoods Following Pathway to Asian Majority\", echo=FALSE, warning=FALSE, message=FALSE}\n# Filter census data to include only clusters 14, 12, and 9 (Asian Majority Pathway clusters)\nasian_majority_clusters <- census_wide %>%\n  filter(sequence_cluster %in% c(14, 12, 9))  \n  \n# Join the filtered data with the tract shapefile (here, use TRTID10)\ntract_asian_majority <- tract %>% erase_water(area_threshold = 0.75) %>% \n  left_join(asian_majority_clusters, by = \"TRTID10\")  # Join with spatial data\n\n# Create a map of the neighborhoods with clusters 14, 12, and 9 with new labels\nggplot(tract_asian_majority) +\n  geom_sf(aes(fill = factor(sequence_cluster)), color = NA) +  # Map sequence clusters\n  geom_sf(data = nyc_counties, fill = NA, color = \"black\", size = 0.5) +  # Add white county borders\n  scale_fill_manual(values = c(\"#8DD3C7\", \"#FFFFB3\", \"#BEBADA\"),  # Custom color palette for Asian Majority clusters\n                    labels = c(\"14 White, Mixed Race to Black & Hispanic to Asian Majority\", \n                               \"12 White Majority to White Mixed Race to Asian\", \n                               \"9 White Mixed Race to Asian\"), \n                    name = \"Asian Majority Pathway\") +\n  labs(title = \"\", \n       x = \"\", y = \"\") +\n  theme_void() +\n  theme(legend.position = \"right\",  # Place legend at the bottom\n        legend.direction = \"vertical\",  # Arrange legend items horizontally\n        legend.title = element_text(size = 12),  # Customize legend title size\n        legend.key.width = unit(2, \"cm\"),  # Adjust legend key width\n        legend.box = \"vertical\")  # Place legend title on top of the legend\n```\n\n```{r whiteandblack}\n# Filter data for Increasing White (clusters 10 and 11)\nincreasing_white_clusters <- census_wide %>% \n  filter(sequence_cluster %in% c(10, 11))  # Clusters 10 and 11 for increasing White\n\n# Filter data for Increasing Black (clusters 1 and 8)\nincreasing_black_clusters <- census_wide %>%\n  filter(sequence_cluster %in% c(1, 8))  # Clusters 1 and 8 for increasing Black\n\n# Join the filtered data with the tract shapefile for each group\ntract_increasing_white <- tract %>%  erase_water(area_threshold = 0.75) %>%\n  left_join(increasing_white_clusters, by = \"TRTID10\")  # Join spatial data for increasing White\n\ntract_increasing_black <- tract %>%   erase_water(area_threshold = 0.75) %>%\n  left_join(increasing_black_clusters, by = \"TRTID10\")  # Join spatial data for increasing Black\n```\n\nThere are two pathways for increasing both Black and White shares in a\nneighborhoods. Neighborhoods that became increasingly White either\nfollowed a trajectory from White mixed race to majority White (Cluster\n10) or from either all Black or Black and Hispanic to White and Mixed\nrace (11). Notably, this transition largely took place within the past\n1-2 decades, aligning with when gentrification trends became accentuated\nin some cities, including New York. We see a clear cluster of this\nlatter group in Brooklyn, a borough whose gentrification trends have\nbeen well documented [@chronopoulos2020s; @halasz2023between].\n\nFor the case of increasing Black populations, Cluster 1 shows a pathway\nfrom Hispanic majority to mixed Black and Hispanic and Cluster 8 shows a\ngradual transition from Black and Hispanic to majority Black; a trend\nthat largely begin towards the middle of the study period, around the\n2000 census data mark. Spatially, the former is more dispersed, while\nthe latter is depicted more clearly in the southern neighborhoods of\nBrooklyn.\n\n```{r WhitePathways, fig.cap=\"Neighborhoods Following Pathway to White Majority\", echo=FALSE, warning=FALSE, message=FALSE}\n# Adjust plotting settings to improve map visibility\n# Create the map for Increasing White, zoomed in on the five boroughs\nggplot(tract_increasing_white) +\n  geom_sf(aes(fill = factor(sequence_cluster)), color = NA) +  # Map sequence clusters\n  geom_sf(data = nyc_counties, fill = NA, color = \"black\", size = 0.5) +  # Add white county borders\n  scale_fill_manual(values = c(\"#8DD3C7\", \"#FFFFB3\"),  # Custom color palette for White clusters\n                    labels = c(\"White Mixed Race to Majority White\", \n                               \"Black and Hispanic to White Mixed Race\"), \n                    name = \"Increasing White Pathway\") +\n  coord_sf(xlim = c(-74.3, -73.7), ylim = c(40.5, 40.9), expand = FALSE) +  # Zoom into the NYC area\n  theme_void() +\n  theme(legend.position = \"right\",  # Place legend at the right\n        legend.direction = \"vertical\",  # Arrange legend items vertically\n        legend.title = element_text(size = 12),  # Customize legend title size\n        legend.key.width = unit(2, \"cm\"),\n        legend.box = \"vertical\")  # Place legend title on top\n```\n\n```{r Black Pathways, fig.cap=\"Neighborhoods Following Pathway to Black Majority\", echo=FALSE, warning=FALSE, message=FALSE}\n# Create the map for Increasing Black, zoomed in on the five boroughs\nggplot(tract_increasing_black) +\n  geom_sf(aes(fill = factor(sequence_cluster)), color = NA) +  # Map sequence clusters\n  geom_sf(data = nyc_counties, fill = NA, color = \"black\", size = 0.5) +  # Add white county borders\n  scale_fill_manual(values = c(\"#FB8072\", \"#80B1D3\"),  # Custom color palette for Black clusters\n                    labels = c(\"Hispanic Majority to Black & Hispanic\", \n                               \"Black and Hispanic to Black Majority\"), \n                    name = \"Increasing Black Pathway\") +\n  coord_sf(xlim = c(-74.3, -73.7), ylim = c(40.5, 40.9), expand = FALSE) +  # Zoom into the NYC area\n  theme_void() +\n  theme(legend.position = \"right\",  # Place legend at the right\n        legend.direction = \"vertical\",  # Arrange legend items vertically\n        legend.title = element_text(size = 12),  # Customize legend title size\n        legend.key.width = unit(2, \"cm\"),\n        legend.box = \"vertical\")  # Place legend title on top\n\n```\n\nFinally, of the sequences depicting no change from 1980 to 2020, shown\nin Cluster 2, the majority of those are for tracts with a racial\nmajority: White, Hispanic, and Black. But those are followed by two\nstable sequences of neighborhoods with some racial diversity. The first\nis the majority White, but with a mixture of other races and the second\nis the mixed Black and Hispanic cluster. There is some debate in the\nliterature whether racially mixed neighborhoods can be stable over time,\nor are they simply depicting a point along a pathway of change when one\ngroup will eventually become a majority. Research has shown that highly\ndiverse neighborhoods are quite unstable over time, likely to transition\nto a less diverse state. In particular the transition from predominantly\nWhite towards majority Hispanic, results in a period of unstable racial\nmixture while that transition takes place [@wright2020instability].\nOthers have identified a small, but persistent set of racially diverse\nneighborhoods throughout the United States, but particularly in racially\ndiverse metropolitan areas [@hipp2023persistent]. Here, we find some\nevidence of stable, non-racially homogeneous Census Tracts.\n\n## Conclusions {#sec-conclusion}\n\nThis analysis showcases a method for developing and visualizing a\ntypology of neighborhood change pathways. We used a case study of\ndecennial racial and ethnic changes in New York City census tracts from\n1980-2020. The workflow first involves developing a cross-sectional\ntypology of classes describing the racial mixture of neighborhoods. To\ndo so, we used an unsupervised classification approach, *k*-means to\nderive six such clusters.\n\nWe demonstrated how determining the number of clusters often falls to\nmore of an art than a precise science as our final clustering for this\nanalysis exceeded the mathematically optimal three clusters, but\nprovided us with more nuance on the racial mixture of neighborhoods. We\nperformed the cluster analysis on all census tracts in the city for each\nof the five decennial census time stamps at once to ensure a temporally\nconsistent set of groupings. We then created sequences of neighborhood\nclusters over the study period and developed a typology of sequences\nthat grouped them based on the similarity of how they changed over time.\nTo do so, we used the OMtrans algorithm for computing sequence\ndissimilarity to ensure that the \\*ordering or sequencing of events was\npreserved. Finally, we mapped sequence clusters to spatially visualize\nneighborhoods that followed similar pathways of change. For our case\nstudy of the largest city in the United States, and one of the most\ndiverse, we observed a decline in the number of majority White census\ntracts over time. We identified several pathways of change leading to\nmajority Hispanic neighborhoods - emerging either out of previously\nmajority White or Black neighborhoods. We also observed pathways leading\nto majority Asian tracts, transitioning from Black and Hispanic\nneighborhoods, largely in Queens. A smaller share of neighborhoods\nbecame either increasingly White or Black. Neighborhoods that saw an\nincrease in the share of Whites, saw a notable increase in the\ntransition from Black and Hispanic to White and mixed race over the past\ntwo decades. Neighborhoods that increased in the share of Blacks largely\ntransitioned from Black and Hispanic to majority Black or from White and\nmixed race to Black and Hispanic. The benefits of the sequence analysis\ntechnique is in the clarity of the visuals for revealing common pathways\nof change. One of its drawbacks is that it requires segmenting\ncontinuous, longitudinal data into discrete, categorical groups. Other\nmethods for clustering time series offer an alternative approach for\nvisualizing trajectories over time.\n"},"formats":{"pdf":{"identifier":{"display-name":"PDF","target-format":"pdf","base-format":"pdf"},"execute":{"fig-width":5.5,"fig-height":3.5,"fig-format":"pdf","fig-dpi":300,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"pdf","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":true,"merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"pdf-engine":"lualatex","standalone":true,"variables":{"graphics":true,"tables":true},"default-image-extension":"pdf","to":"pdf","toc":true,"highlight-style":"tango","include-in-header":["preamble.tex"],"output-file":"index_pdf.pdf"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"block-headings":true,"title":"Sequence Analysis of Neighborhood Racial and Ethnic Changes: The Case of New York City 1980-2020","author":[{"name":"Elizabeth Delmelle","affiliations":[{"name":"University of Pennsylvania","department":"City and Regional Planning"}],"orcid":"0000-0003-3735-8359","email":"delmelle@upenn.edu"},{"name":"Eric Delmelle","affiliations":[{"name":"Vrije University Brussels","department":"Geography"}],"orcid":"0000-0002-5117-2238","email":"delmelle@gmail.com"}],"date":"2024-09-16","abstract":"This paper demonstrates the application of sequence analysis to develop a typology of racial and ethnic trajectories in New York City neighborhoods from 1980 to 2020 using a reproducible R workflow. Our workflow begins with using an unsupervised classification method, k-means, at each decennial cross-section to derive 6 classes describing the racial and ethnic makeup of neighborhoods during the study period. These classes include four that depict a majority of Black, White, Hispanic, and Asian residents, and two mixed-race classes, Black and Hispanic, and a White majority with a mixture of other races. We then develop a sequence of classes for each census tract over the 5 decennial time stamps. Finally, we derive a longitudinal typology describing the predominant pathways of change using sequence analysis. This resulted in 14 distinct pathways including transitions to Hispanic and Asian majorities emerging from historically White or Black neighborhoods. The findings underscore the gradual nature of neighborhood racial transformations. Our approach is reproducible for researchers wanting to explore and visualize multidimensional neighborhood dynamics.\n","keywords":["sequence analysis","neighborhood change","New York City"],"bibliography":["references.bib"],"editor_options":{"markdown":{"wrap":72}},"documentclass":"article"},"extensions":{"book":{"selfContainedOutput":true}}}},"projectFormats":["html"]}